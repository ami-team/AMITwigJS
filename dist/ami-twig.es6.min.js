/*!
 * AMI Twig Engine 1.2.0
 *
 * Copyright © 2014-2023 CNRS/LPSC
 *
 * Author: Jérôme ODIER (jerome.odier@lpsc.in2p3.fr)
 *
 * Repositories: https://gitlab.in2p3.fr/ami-team/AMITwigJS/
 *               https://www.github.com/ami-team/AMITwigJS/
 *
 * This software is a computer program whose purpose is to provide a
 * JavaScript implementation of the SensioLabs's TWIG template engine.
 *
 * This software is governed by the CeCILL-C license under French law and
 * abiding by the rules of distribution of free software. You can use,
 * modify and/or redistribute the software under the terms of the CeCILL-C
 * license as circulated by CEA, CNRS and INRIA at the following URL
 * "http://www.cecill.info".
 *
 * The fact that you are presently reading this means that you have had
 * knowledge of the CeCILL-C license and that you accept its terms.
 *
 */
!function(){"use strict";const amiTwig={version:"1.2.0"};"object"==typeof module&&"object"==typeof module.exports?module.exports.amiTwig=amiTwig:"undefined"!=typeof window?window.amiTwig=amiTwig:"undefined"!=typeof global&&(global.amiTwig=amiTwig),amiTwig.tokenizer={tokenize:function(e,t,i,n,r,s){if(n.length!==r.length)throw"`tokenDefs.length != tokenTypes.length`";var o=[],a=[],h=[];let p=0;var l=e.length;let c="",u,k;e:for(;p<l;){if("\n"===(k=e.charAt(0))&&t++,0<=i.indexOf(k)){if(c){if(s)throw"invalid token `"+c+"`";o.push(c),a.push(-1),h.push(t),c=""}}else{for(const g in n)if(u=this._match(e,n[g])){if(c){if(s)throw"invalid token `"+c+"`";o.push(c),a.push(-1),h.push(t),c=""}o.push(u),a.push(r[g]),h.push(t),e=e.substring(u.length),p+=u.length;continue e}c+=k}e=e.substring(1),p+=1}if(c){if(s)throw"invalid token `"+c+"`";o.push(c),a.push(-1),h.push(t)}return{tokens:o,types:a,lines:h}},_match:function(e,t){let i;return t instanceof RegExp?null!==(i=e.match(t))&&this._checkNextChar(e,i[0])?i[0]:null:0===(i=e.indexOf(t))&&this._checkNextChar(e,t)?t:null},_alphanum:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],_checkNextChar:function(e,t){var t=t.length,i=e.charCodeAt(+t),e=e.charCodeAt(t-1);return isNaN(i)||0===this._alphanum[i]||0===this._alphanum[e]}},amiTwig.expr={},amiTwig.expr.tokens={$init:function(){this.IS_XXX=[this.DEFINED,this.NULL,this.EMPTY,this.ITERABLE,this.EVEN,this.ODD],this.XXX_WITH=[this.STARTS_WITH,this.ENDS_WITH],this.PLUS_MINUS=[this.CONCAT,this.PLUS,this.MINUS],this.MUL_FLDIV_DIV_MOD=[this.MUL,this.FLDIV,this.DIV,this.MOD],this.RX=[this.RP,this.RB1]},LOGICAL_OR:100,LOGICAL_AND:101,BITWISE_OR:102,BITWISE_XOR:103,BITWISE_AND:104,NOT:105,IS:106,DEFINED:107,NULL:108,EMPTY:109,ITERABLE:110,EVEN:111,ODD:112,CMP_OP:113,STARTS_WITH:114,ENDS_WITH:115,MATCHES:116,IN:117,RANGE:118,CONCAT:119,PLUS:120,MINUS:121,POWER:122,MUL:123,FLDIV:124,DIV:125,MOD:126,DOUBLE_QUESTION:127,QUESTION:128,COLON:129,DOT:130,COMMA:131,PIPE:132,LP:133,RP:134,LB1:135,RB1:136,LB2:137,RB2:138,SID:139,TERMINAL:140,LST:200,DIC:201,FUN:202,VAR:203},amiTwig.expr.tokens.$init(),amiTwig.expr.Tokenizer=function(e,t){this._spaces=[" ","\t","\n","\r"],this._tokenDefs=["or","and","b-or","b-xor","b-and","not","is","defined","null","empty","iterable","even","odd","===","==","!==","!=","<=",">=","<",">",/^starts\s+with/,/^ends\s+with/,"matches","in","..","~","+","-","**","*","//","/","%","??","?",":",".",",","|","(",")","[","]","{","}","true","false",/^[0-9]+\.[0-9]+/,/^[0-9]+/,/^'(\\'|[^'])*'/,/^"(\\"|[^"])*"/,/^[a-zA-Z_$][a-zA-Z0-9_$]*/],this._tokenTypes=[amiTwig.expr.tokens.LOGICAL_OR,amiTwig.expr.tokens.LOGICAL_AND,amiTwig.expr.tokens.BITWISE_OR,amiTwig.expr.tokens.BITWISE_XOR,amiTwig.expr.tokens.BITWISE_AND,amiTwig.expr.tokens.NOT,amiTwig.expr.tokens.IS,amiTwig.expr.tokens.DEFINED,amiTwig.expr.tokens.NULL,amiTwig.expr.tokens.EMPTY,amiTwig.expr.tokens.ITERABLE,amiTwig.expr.tokens.EVEN,amiTwig.expr.tokens.ODD,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.STARTS_WITH,amiTwig.expr.tokens.ENDS_WITH,amiTwig.expr.tokens.MATCHES,amiTwig.expr.tokens.IN,amiTwig.expr.tokens.RANGE,amiTwig.expr.tokens.CONCAT,amiTwig.expr.tokens.PLUS,amiTwig.expr.tokens.MINUS,amiTwig.expr.tokens.POWER,amiTwig.expr.tokens.MUL,amiTwig.expr.tokens.FLDIV,amiTwig.expr.tokens.DIV,amiTwig.expr.tokens.MOD,amiTwig.expr.tokens.DOUBLE_QUESTION,amiTwig.expr.tokens.QUESTION,amiTwig.expr.tokens.COLON,amiTwig.expr.tokens.DOT,amiTwig.expr.tokens.COMMA,amiTwig.expr.tokens.PIPE,amiTwig.expr.tokens.LP,amiTwig.expr.tokens.RP,amiTwig.expr.tokens.LB1,amiTwig.expr.tokens.RB1,amiTwig.expr.tokens.LB2,amiTwig.expr.tokens.RB2,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.SID],this.$init=function(e,t){e=amiTwig.tokenizer.tokenize(e,t,this._spaces,this._tokenDefs,this._tokenTypes,!0);this.tokens=e.tokens,this.types=e.types,this.i=0},this.next=function(e=1){this.i+=e},this.isEmpty=function(){return this.i>=this.tokens.length},this.peekToken=function(){return this.tokens[this.i]},this.peekType=function(){return this.types[this.i]},this.checkType=function(e){var t;return this.i<this.tokens.length&&(t=this.types[this.i],e instanceof Array?0<=e.indexOf(t):e===t)},this.$init(e,t)},amiTwig.expr.Compiler=function(e,t){this.$init(e,t)},amiTwig.expr.Compiler.prototype={$init:function(e,t){if(this.tokenizer=new amiTwig.expr.Tokenizer(this.code=e,this.line=t),this.rootNode=this.parseNullCoalescing(),!1===this.tokenizer.isEmpty())throw"syntax error, line `"+this.line+"`, unexpected token `"+this.tokenizer.peekToken()+"`"},dump:function(){return this.rootNode.dump()},parseNullCoalescing:function(){let e=this.parseLogicalOr(),t,i;for(;this.tokenizer.checkType(amiTwig.expr.tokens.DOUBLE_QUESTION);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t=this.parseLogicalOr(),i.nodeLeft=e,i.nodeRight=t,e=i;return e},parseLogicalOr:function(){let e=this.parseLogicalAnd(),t,i;for(;this.tokenizer.checkType(amiTwig.expr.tokens.LOGICAL_OR);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t=this.parseLogicalAnd(),i.nodeLeft=e,i.nodeRight=t,e=i;return e},parseLogicalAnd:function(){let e=this.parseBitwiseOr(),t,i;for(;this.tokenizer.checkType(amiTwig.expr.tokens.LOGICAL_AND);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t=this.parseBitwiseOr(),i.nodeLeft=e,i.nodeRight=t,e=i;return e},parseBitwiseOr:function(){let e=this.parseBitwiseXor(),t,i;for(;this.tokenizer.checkType(amiTwig.expr.tokens.BITWISE_OR);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t=this.parseBitwiseXor(),i.nodeLeft=e,i.nodeRight=t,e=i;return e},parseBitwiseXor:function(){let e=this.parseBitwiseAnd(),t,i;for(;this.tokenizer.checkType(amiTwig.expr.tokens.BITWISE_XOR);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t=this.parseBitwiseAnd(),i.nodeLeft=e,i.nodeRight=t,e=i;return e},parseBitwiseAnd:function(){let e=this.parseNot(),t,i;for(;this.tokenizer.checkType(amiTwig.expr.tokens.BITWISE_AND);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t=this.parseNot(),i.nodeLeft=e,i.nodeRight=t,e=i;return e},parseNot:function(){var e,t;return this.tokenizer.checkType(amiTwig.expr.tokens.NOT)?(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseComp(),t.nodeLeft=null,t.nodeRight=e,t):this.parseComp()},parseComp:function(){let e=this.parseAddSub(),t,i,n;if(this.tokenizer.checkType(amiTwig.expr.tokens.IS)){if(i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),n=i,this.tokenizer.checkType(amiTwig.expr.tokens.NOT)&&(i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),i.nodeLeft=null,i.nodeRight=n),!this.tokenizer.checkType(amiTwig.expr.tokens.IS_XXX))throw"syntax error, line `"+this.line+"`, keyword `defined`, `null`, `empty`, `iterable`, `even` or `odd` expected";t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),n.nodeLeft=e,n.nodeRight=t,e=i}else(this.tokenizer.checkType(amiTwig.expr.tokens.CMP_OP)||this.tokenizer.checkType(amiTwig.expr.tokens.XXX_WITH)||this.tokenizer.checkType(amiTwig.expr.tokens.MATCHES)||this.tokenizer.checkType(amiTwig.expr.tokens.IN))&&(i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t=this.parseAddSub(),i.nodeLeft=e,i.nodeRight=t,e=i);return e},parseAddSub:function(){let e=this.parseMulDiv(),t,i;for(;this.tokenizer.checkType(amiTwig.expr.tokens.PLUS_MINUS);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t=this.parseMulDiv(),i.nodeLeft=e,i.nodeRight=t,e=i;return e},parseMulDiv:function(){let e=this.parsePlusMinus(),t,i;for(;this.tokenizer.checkType(amiTwig.expr.tokens.MUL_FLDIV_DIV_MOD);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t=this.parsePlusMinus(),i.nodeLeft=e,i.nodeRight=t,e=i;return e},parsePlusMinus:function(){var e,t;return this.tokenizer.checkType(amiTwig.expr.tokens.PLUS_MINUS)?(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parsePower(),t.nodeLeft=null,t.nodeRight=e,t):this.parsePower()},parsePower:function(){let e=this.parseFilter(),t,i;for(;this.tokenizer.checkType(amiTwig.expr.tokens.POWER);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t=this.parseFilter(),i.nodeLeft=e,i.nodeRight=t,e=i;return e},parseFilter:function(){let e=this.parseDot1(),t,i;for(;this.tokenizer.checkType(amiTwig.expr.tokens.PIPE);){for(this.tokenizer.next(),t=this.parseDot1(!0),i=t;i.nodeType===amiTwig.expr.tokens.DOT;i=i.nodeLeft);i.list.unshift(e),e=t}return e},parseDot1:function(t){t=this.parseDot2(t);if(t){let e;for(e=t;e.nodeType===amiTwig.expr.tokens.DOT;e=e.nodeLeft);e.q&&(e.nodeType===amiTwig.expr.tokens.FUN?e.nodeValue in amiTwig.stdlib?e.nodeValue="amiTwig.stdlib."+e.nodeValue:e.nodeValue="_."+e.nodeValue:e.nodeType===amiTwig.expr.tokens.VAR&&(e.nodeValue="_."+e.nodeValue),e.q=!1)}return t},parseDot2:function(e){let t=this.parseDot3(e),i,n;for(;this.tokenizer.checkType(amiTwig.expr.tokens.DOT);)n=new amiTwig.expr.Node(this.tokenizer.peekType(),"."),this.tokenizer.next(),i=this.parseDot3(e),n.nodeLeft=t,n.nodeRight=i,t=n;return t},parseDot3:function(e){let t=this.parseX(e),i,n;for(;this.tokenizer.checkType(amiTwig.expr.tokens.LB1);){if(this.tokenizer.next(),i=this.parseNullCoalescing(),!this.tokenizer.checkType(amiTwig.expr.tokens.RB1))throw"syntax error, line `"+this.line+"`, `]` expected";this.tokenizer.next(),(n=new amiTwig.expr.Node(amiTwig.expr.tokens.DOT,"[]")).nodeLeft=t,n.nodeRight=i,t=n}return t},parseX:function(e){var t;if(t=this.parseGroup())return t;if(t=this.parseArray())return t;if(t=this.parseObject())return t;if(t=this.parseFunVar(e))return t;if(t=this.parseTerminal())return t;throw"syntax error, line `"+this.line+"`, syntax error or truncated expression"},parseGroup:function(){var e;if(this.tokenizer.checkType(amiTwig.expr.tokens.LP)){if(this.tokenizer.next(),e=this.parseNullCoalescing(),this.tokenizer.checkType(amiTwig.expr.tokens.RP))return this.tokenizer.next(),e;throw"syntax error, line `"+this.line+"`, `)` expected"}return null},parseArray:function(){var e,t;if(this.tokenizer.checkType(amiTwig.expr.tokens.LB1)){if(this.tokenizer.next(),t=this._parseSinglets(),this.tokenizer.checkType(amiTwig.expr.tokens.RB1))return this.tokenizer.next(),(e=new amiTwig.expr.Node(amiTwig.expr.tokens.LST,"Array")).list=t,e;throw"syntax error, line `"+this.line+"`, `]` expected"}return null},parseObject:function(){var e,t;if(this.tokenizer.checkType(amiTwig.expr.tokens.LB2)){if(this.tokenizer.next(),t=this._parseDoublets(),this.tokenizer.checkType(amiTwig.expr.tokens.RB2))return this.tokenizer.next(),(e=new amiTwig.expr.Node(amiTwig.expr.tokens.DIC,"Object")).dict=t,e;throw"syntax error, line `"+this.line+"`, `}` expected"}return null},parseFunVar:function(e){var t;if(this.tokenizer.checkType(amiTwig.expr.tokens.SID)){if((t=new amiTwig.expr.Node(0,e?"filter_"+this.tokenizer.peekToken():this.tokenizer.peekToken())).q=!0,this.tokenizer.next(),this.tokenizer.checkType(amiTwig.expr.tokens.LP)){if(this.tokenizer.next(),t.list=this._parseSinglets(),!this.tokenizer.checkType(amiTwig.expr.tokens.RP))throw"syntax error, line `"+this.line+"`, `)` expected";this.tokenizer.next(),t.nodeType=amiTwig.expr.tokens.FUN}else t.nodeType=e?amiTwig.expr.tokens.FUN:amiTwig.expr.tokens.VAR,t.list=[];return t}return null},_parseSinglets:function(){for(var e=[];!1===this.tokenizer.checkType(amiTwig.expr.tokens.RX)&&(this._parseSinglet(e),!0===this.tokenizer.checkType(amiTwig.expr.tokens.COMMA));)this.tokenizer.next();return e},_parseDoublets:function(){for(var e={};!1===this.tokenizer.checkType(amiTwig.expr.tokens.RB2)&&(this._parseDoublet(e),!0===this.tokenizer.checkType(amiTwig.expr.tokens.COMMA));)this.tokenizer.next();return e},_parseSinglet:function(e){e.push(this.parseNullCoalescing())},_parseDoublet:function(e){if(!this.tokenizer.checkType(amiTwig.expr.tokens.TERMINAL))throw"syntax error, line `"+this.line+"`, terminal expected";var t=this.tokenizer.peekToken();if(this.tokenizer.next(),!this.tokenizer.checkType(amiTwig.expr.tokens.COLON))throw"syntax error, line `"+this.line+"`, `:` expected";this.tokenizer.next(),e[t]=this.parseNullCoalescing()},parseTerminal:function(){var e,t,i;if(this.tokenizer.checkType(amiTwig.expr.tokens.TERMINAL)){if(e=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),!this.tokenizer.checkType(amiTwig.expr.tokens.RANGE))return e;if(i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),this.tokenizer.checkType(amiTwig.expr.tokens.TERMINAL))return t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),i.nodeLeft=e,i.nodeRight=t,i}return null}},amiTwig.expr.Node=function(e,t){this.$init(e,t)},amiTwig.expr.Node.prototype={$init:function(e,t){this.nodeType=e,this.nodeValue=t,this.nodeLeft=null,this.nodeRight=null,this.list=null,this.dict=null},_dump:function(e,t,i){let n;var r=i[0];if(e.push("\tnode"+r+' [label="'+this.nodeValue.replace(/"/g,'\\"')+'"];'),this.nodeLeft&&(n=++i[0],t.push("\tnode"+r+" -> node"+n+";"),this.nodeLeft._dump(e,t,i)),this.nodeRight&&(n=++i[0],t.push("\tnode"+r+" -> node"+n+";"),this.nodeRight._dump(e,t,i)),this.list)for(const s in this.list)n=++i[0],t.push("\tnode"+r+" -> node"+n+' [label="['+s.replace(/"/g,'\\"')+']"];'),this.list[s]._dump(e,t,i);if(this.dict)for(const o in this.dict)n=++i[0],t.push("\tnode"+r+" -> node"+n+' [label="['+o.replace(/"/g,'\\"')+']"];'),this.dict[o]._dump(e,t,i)},dump:function(){var e=[],t=[];return this._dump(e,t,[0]),"digraph ast {\n\trankdir=TB;\n"+e.join("\n")+"\n"+t.join("\n")+"\n}"}},amiTwig.tmpl={},amiTwig.tmpl.Compiler=function(e){this.$init(e)},amiTwig.tmpl.Compiler.prototype={STATEMENT_RE:/{%\s*([a-zA-Z]+)\s*((?:.|\n)*?)\s*%}/,COMMENT_RE:/{#\s*((?:.|\n)*?)\s*#}/g,_count:function(t){let i=0;var n=t.length;for(let e=0;e<n;e++)"\n"===t[e]&&i++;return i},$init:function(t){let i=1;let n;this.rootNode={line:i,keyword:"@root",expression:"",blocks:[{expression:"@true",list:[]}],value:""};var r=[this.rootNode],s=[0];let o;for(t=t.replace(this.COMMENT_RE,"");;t=t.substr(n)){var a=r[r.length-1];let e=s[s.length-1];var h=t.match(this.STATEMENT_RE);if(null===h){i+=this._count(t),a.blocks[e].list.push({line:i,keyword:"@text",expression:"",blocks:[],value:t});var p=[];for(let e=r.length-1;0<e;e--)"if"===r[e].keyword?p.push("missing keyword `endif`"):"for"===r[e].keyword&&p.push("missing keyword `endfor`");if(0<p.length)throw"syntax error, line `"+i+"`, "+p.join(", ");break}var l=h[0],c=h[1],u=h[2],k=h.index+0,h=(n=h.index+l.length,t.substr(0,k)),l=t.substr(0,n);switch(i+=this._count(l),h&&(o={line:i,keyword:"@text",expression:"",blocks:[],value:h},a.blocks[e].list.push(o)),c){case"flush":case"autoescape":case"spaceless":case"verbatim":break;case"do":case"set":case"include":o={line:i,keyword:c,expression:u,blocks:[],value:""},a.blocks[e].list.push(o);break;case"if":case"for":o={line:i,keyword:c,blocks:[{expression:u,list:[]}],value:""},a.blocks[e].list.push(o),r.push(o),s.push(0);break;case"elseif":if("if"!==a.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `elseif`";e=a.blocks.length,a.blocks.push({expression:u,list:[]}),s[s.length-1]=e;break;case"else":if("if"!==a.keyword&&"for"!==a.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `else`";e=a.blocks.length,a.blocks.push({expression:"@true",list:[]}),s[s.length-1]=e;break;case"endif":if("if"!==a.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `endif`";r.pop(),s.pop();break;case"endfor":if("for"!==a.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `endfor`";r.pop(),s.pop();break;default:throw"syntax error, line `"+i+"`, unknown keyword `"+c+"`"}}},dump:function(){return JSON.stringify(this.rootNode,null,2)}},amiTwig.engine={VARIABLE_RE:/{{\s*(.*?)\s*}}/g,_render:function(r,s,o={},a={}){let h,n;switch(this.dict=o,this.tmpls=a,s.keyword){case"do":amiTwig.expr.cache.eval(s.expression,s.line,o);break;case"set":{if(!(h=s.expression.match(/((?:[a-zA-Z_$][a-zA-Z0-9_$]*\.)*[a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*(.+)/)))throw"syntax error, line `"+s.line+"`, invalid `set` statement";var p=h[1].split("."),l=p.length-1;let e,t;if("window"===p[0]||"global"===p[0]){if("undefined"!=typeof window)e=window;else{if("undefined"==typeof global)throw"internal error";e=global}t=1}else e=o,t=0;let i;for(i=t;i<l;i++){if(!e[p[i]])throw"runtime error, line `"+s.line+"`, `"+h[1]+"` not declared";e=e[p[i]]}e[p[i]]=amiTwig.expr.cache.eval(h[2],s.line,o);break}case"@text":r.push(s.value.replace(this.VARIABLE_RE,function(e,t){t=amiTwig.expr.cache.eval(t,s.line,o);return null!=t?t:""}));break;case"if":case"@root":s.blocks.every(e=>{if("@true"===(n=e.expression)||amiTwig.expr.cache.eval(n,s.line,o)){for(const t in e.list)this._render(r,e.list[t],o,a);return!1}return!0});break;case"for":{let t,i,e;if(h=s.blocks[0].expression.match(/([a-zA-Z_$][a-zA-Z0-9_$]*)\s*,\s*([a-zA-Z_$][a-zA-Z0-9_$]*)\s+in\s+(.+)/))t=h[1],i=h[2],e=h[3];else{if(!(h=s.blocks[0].expression.match(/([a-zA-Z_$][a-zA-Z0-9_$]*)\s+in\s+(.+)/)))throw"syntax error, line `"+s.line+"`, invalid `for` statement";t=h[1],i=null,e=h[2]}var c=amiTwig.expr.cache.eval(e,s.line,o),u=Object.prototype.toString.call(c);let n;if("[object Object]"===u)n=i?Object.entries(c):Object.keys(c);else{if(n=c,"[object Array]"!==u&&"[object String]"!==u)throw"syntax error, line `"+s.line+"`, right operand not iterable";if(i)throw"syntax error, line `"+s.line+"`, right operand not an object"}var k=n.length;if(0<k){let e=0;var g=s.blocks[0].list;if(i){var c=o[t],u=o[i],T=o.loop;o.loop={length:k,parent:o.loop};for(const d in n){o[t]=n[d][0],o[i]=n[d][1],o.loop.first=0===e,o.loop.last=e===k-1,o.loop.revindex0=k-e,o.loop.index0=e,e++,o.loop.revindex=k-e,o.loop.index=e;for(const w in g)this._render(r,g[w],o,a)}o.loop=T,o[i]=u,o[t]=c}else{T=o[t],u=o.loop;o.loop={length:k,parent:o.loop};for(const m in n){o[t]=n[m],o.loop.first=0===e,o.loop.last=e===k-1,o.loop.revindex0=k-e,o.loop.index0=e,e++,o.loop.revindex=k-e,o.loop.index=e;for(const x in g)this._render(r,g[x],o,a)}o.loop=u,o[t]=T}}else if(1<s.blocks.length){var f=s.blocks[1].list;for(const _ in f)this._render(r,f[_],o,a)}break}case"include":{let e=s.expression,t,i;i=(h=e.match(/(.+)\s+with\s+(.+)\s+only$/))?(n=h[1],t=h[2],!1):(h=e.match(/(.+)\s+with\s+(.+)$/))?(n=h[1],t=h[2],!0):(h=e.match(/(.+)\s+only$/))?(n=h[1],!(t="{}")):(n=e,t="{}",!0);c=amiTwig.expr.cache.eval(n,s.line,o)||"";if("[object String]"!==Object.prototype.toString.call(c))throw"runtime error, line `"+s.line+"`, string expected";u=amiTwig.expr.cache.eval(t,s.line,o)||{};if("[object Object]"!==Object.prototype.toString.call(u))throw"runtime error, line `"+s.line+"`, object expected";r.push(amiTwig.stdlib.include(c,u,i,!1));break}}},render:function(e,t={},i={}){var n=[];switch(Object.prototype.toString.call(e)){case"[object String]":this._render(n,new amiTwig.tmpl.Compiler(e).rootNode,t,i);break;case"[object Object]":this._render(n,e,t,i)}return n.join("")}},amiTwig.expr.cache={dict:{},eval:function(expression,line,_){let f;return f=expression in this.dict?this.dict[expression]:this.dict[expression]=eval(amiTwig.expr.interpreter.getJS(new amiTwig.expr.Compiler(expression,line))),_=_||{},f.call(_,_)}},amiTwig.stdlib={isUndefined:function(e){return void 0===e},isDefined:function(e){return void 0!==e},isNull:function(e){return null===e},isNotNull:function(e){return null!==e},isEmpty:function(e){var t;return null===e||!1===e||""===e||"[object Array]"===(t=Object.prototype.toString.call(e))&&0===e.length||("[object Set]"===t||"[object WeakSet]"===t)&&0===e.size||("[object Object]"===t||"[object Map]"===t||"[object WeakMap]"===t)&&0===Object.keys(e).length},isNumber:function(e){e=Object.prototype.toString.call(e);return"[object Number]"===e||"[object BigInt]"===e},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)},isDate:function(e){return"[object Date]"===Object.prototype.toString.call(e)},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},isObject:function(e){return"[object Object]"===Object.prototype.toString.call(e)},isSet:function(e){e=Object.prototype.toString.call(e);return"[object Set]"===e||"[object WeakSet]"===e},isMap:function(e){e=Object.prototype.toString.call(e);return"[object Object]"===e||"[object Map]"===e||"[object WeakMap]"===e},isIterable:function(e){e=Object.prototype.toString.call(e);return"[object String]"===e||"[object Array]"===e||"[object Object]"===e||"[object Set]"===e||"[object WeakSet]"===e||"[object Map]"===e||"[object WeakMap]"===e},isEven:function(e){return this.isNumber(e)&&0==(1&e)},isOdd:function(e){return this.isNumber(e)&&1==(1&e)},isInObject:function(e,t){return this.isArray(t)||this.isString(t)?0<=t.indexOf(e):this.isSet(t)?t.has(e):!!this.isMap(t)&&Object.prototype.hasOwnProperty.call(t,e)},isInRange:function(e,t,i){return this.isNumber(t)&&this.isNumber(i)?t<=e&&e<=i:!(!this.isString(t)||1!==t.length||!this.isString(i)||1!==i.length)&&e.charCodeAt(0)>=t.charCodeAt(0)&&e.charCodeAt(0)<=i.charCodeAt(0)},range:function(t,i,n=1){var r=[];if(this.isNumber(t)&&this.isNumber(i))for(let e=t;e<=i;e+=n)r.push(e);else if(this.isString(t)&&1===t.length&&this.isString(i)&&1===i.length)for(let e=t.charCodeAt(0);e<=i.charCodeAt(0);e+=n)r.push(String.fromCharCode(e));return r},filter_length:function(e){return this.isString(e)||this.isArray(e)||this.isSet(e)?e.length:this.isSet(e)?e.size:this.isMap(e)?Object.keys(e).length:0},filter_first:function(e){return(this.isString(e)||this.isArray(e))&&0<e.length?e[0]:""},filter_last:function(e){return(this.isString(e)||this.isArray(e))&&0<e.length?e[e.length-1]:""},filter_slice:function(e,t,i){return this.isString(e)||this.isArray(e)?e.slice(t,i):null},filter_merge:function(){if(1<arguments.length){if(this.isString(arguments[0])){var e=[];for(const o in arguments){var t=arguments[o];if(!this.isString(t))return null;e.push(arguments[o])}return e.join("")}if(this.isArray(arguments[0])){const a=[];for(const h in arguments){var i=arguments[h];if(!this.isArray(i))return null;i.forEach(e=>a.push(e))}return a}if(this.isSet(arguments[0])){const p=[];for(const l in arguments){var n=arguments[l];if(!this.isSet(n))return null;n.forEach(e=>p.add(e))}return p}if(this.isObject(arguments[0])){var r={};for(const c in arguments){var s=arguments[c];if(!this.isObject(s))return null;for(const u in s)r[u]=s[u]}return r}}return null},filter_sort:function(e){return this.isArray(e)?e.sort():[]},filter_reverse:function(e){return this.isArray(e)?e.reverse():[]},filter_join:function(e,t){return this.isArray(e)?e.join(t):""},filter_keys:function(e){return this.isMap(e)?Object.keys(e):[]},filter_column:function(e,t){return this.isArray(e)?e.map(e=>e[t]):[]},filter_batch:function(i,n,r=""){var s=[];if(this.isArray(i)&&this.isNumber(n)){var o=i.length;if(0<o){let t;var a=Math.ceil(o/n)*n;for(let e=0;e<o;e+=n)s.push(t=i.slice(e,e+n));for(let e=o;e<a;e+=1)t.push(r)}}return s},startsWith:function(e,t){return!(!this.isString(e)||!this.isString(t))&&0===e.indexOf(t,0)},endsWith:function(e,t){var i;return!(!this.isString(e)||!this.isString(t))&&(i=e.length-t.length,e.indexOf(t,i)===i)},match:function(e,t){if(this.isString(e)&&this.isString(t)){var i=t.indexOf("/"),n=t.lastIndexOf("/");if(0===i||i<n)try{return new RegExp(t.substring(i+1,n),t.substring(n+1)).test(e)}catch(e){}}return!1},filter_default:function(e,t){return e||t||""},filter_lower:function(e){return this.isString(e)?e.toLowerCase():""},filter_upper:function(e){return this.isString(e)?e.toUpperCase():""},filter_capitalize:function(e){return this.isString(e)?e.trim().toLowerCase().replace(/^\S/g,function(e){return e.toUpperCase()}):""},filter_title:function(e){return this.isString(e)?e.trim().toLowerCase().replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()}):""},filter_trim:function(e){return this.isString(e)?e.trim():""},_replace:function(e,i,n){var r=[],s=e.length,o=i.length;if(o!==n.length)throw"internal error";e:for(let t=0;t<s;t+=0){var a=e.substring(t);for(let e=0;e<o;e+=1)if(0===a.indexOf(i[e])){r.push(n[e]),t+=i[e].length;continue e}r.push(e.charAt(t++))}return r.join("")},_textToHtmlX:["&",'"',"<",">"],_textToHtmlY:["&amp;","&quot;","&lt;","&gt;"],_textToStringX:["\\","\r","\n",'"',"'"],_textToStringY:["\\\\","\\r","\\n",'\\"',"\\'"],_textToJsonStringX:["\\","\r","\n",'"'],_textToJsonStringY:["\\\\","\\r","\\n",'\\"'],filter_escape:function(e,t){if(this.isString(e))switch(t||"html"){case"html":case"html_attr":return this._replace(e,this._textToHtmlX,this._textToHtmlY);case"js":case"string":return this._replace(e,this._textToStringX,this._textToStringY);case"json":return this._replace(e,this._textToJsonStringX,this._textToJsonStringY);case"url":return encodeURIComponent(e);default:return e}return""},filter_url_encode:function(e){return this.isString(e)?encodeURIComponent(e):""},filter_nl2br:function(e){return this.isString(e)?e.replace(/\n/g,"<br/>"):""},filter_raw:function(e){return this.isString(e)?e:""},filter_replace:function(e,t){return this.isString(e)&&this.isMap(t)?this._replace(e,Object.keys(t),Object.values(t)):""},filter_split:function(e,t,i){return this.isString(e)?e.split(t,i):[]},filter_format_number:function(e){return parseFloat(e)},filter_format_decimal_number:function(e){return parseInt(e)},filter_abs:function(e){return Math.abs(e)},filter_round:function(e,t){switch(t){case"ceil":return Math.ceil(e);case"floor":return Math.floor(e);default:return Math.round(e)}},min:function(){var e=1===arguments.length&&(this.isArray(arguments[0])||this.isObject(arguments[0]))?arguments[0]:arguments;let t=Number.POSITIVE_INFINITY;for(const i in e){if(!this.isNumber(e[i]))return Number.NaN;t>e[i]&&(t=e[i])}return t},max:function(){var e=1===arguments.length&&(this.isArray(arguments[0])||this.isObject(arguments[0]))?arguments[0]:arguments;let t=Number.NEGATIVE_INFINITY;for(const i in e){if(!this.isNumber(e[i]))return Number.NaN;t<e[i]&&(t=e[i])}return t},random:function(e){var t,i=Math.random();if(e){if(this.isArray(e)||this.isMap(e))return e[(t=Object.keys(e))[Math.floor(t.length*i)]];if(this.isString(e))return e[Math.floor(e.length*i)];if(this.isNumber(e))return Math.floor(e*i)}return e=Number.MAX_SAFE_INTEGER,Math.floor(e*i)},filter_date:function(e,t,i){return"undefined"!=typeof moment&&(this.isDate(e)||this.isString(e))&&this.isString(t)?(void 0!==moment.tz&&this.isString(i)?moment(e).tz(i):moment(e)).format(t):""},filter_json_encode:function(e,t){return JSON.stringify(e,null,this.isNumber(t)?t:2)},filter_json_jspath:function(e,t){return"undefined"!=typeof JSPath?JSPath.apply(t,e):[]},include:function(e,t={},i=!0,n=!1){if(e in amiTwig.engine.tmpls){var r={};if(i)for(const s in amiTwig.engine.dict)r[s]=amiTwig.engine.dict[s];if(t)for(const o in t)r[o]=t[o];return amiTwig.engine.render(amiTwig.engine.tmpls[e],r)}if(n)return"";throw"runtime error, could not open `"+e+"`"}},amiTwig.stdlib.filter_e=amiTwig.stdlib.filter_escape,amiTwig.expr.interpreter={_getJS:function(e){let t;var i;let n,r,s;switch(e.nodeType){case amiTwig.expr.tokens.LST:t=[];for(const o in e.list)t.push(this._getJS(e.list[o]));return"["+t.join(",")+"]";case amiTwig.expr.tokens.DIC:t=[];for(const a in e.dict)t.push(a+":"+this._getJS(e.dict[a]));return"{"+t.join(",")+"}";case amiTwig.expr.tokens.FUN:t=[];for(const h in e.list)t.push(this._getJS(e.list[h]));return e.nodeValue+"("+t.join(",")+")";case amiTwig.expr.tokens.VAR:t=[];for(const p in e.list)t.push("["+this._getJS(e.list[p])+"]");return 0<t.length?e.nodeValue+t.join(""):e.nodeValue;case amiTwig.expr.tokens.TERMINAL:return e.nodeValue;case amiTwig.expr.tokens.IS:switch(n=this._getJS(e.nodeLeft),e.nodeRight.nodeType){case amiTwig.expr.tokens.DEFINED:return"amiTwig.stdlib.isDefined("+n+")";case amiTwig.expr.tokens.NULL:return"amiTwig.stdlib.isNull("+n+")";case amiTwig.expr.tokens.EMPTY:return"amiTwig.stdlib.isEmpty("+n+")";case amiTwig.expr.tokens.ITERABLE:return"amiTwig.stdlib.isIterable("+n+")";case amiTwig.expr.tokens.EVEN:return"amiTwig.stdlib.isEven("+n+")";case amiTwig.expr.tokens.ODD:return"amiTwig.stdlib.isOdd("+n+")";default:throw"internal error"}case amiTwig.expr.tokens.IN:return e.nodeRight.nodeType!==amiTwig.expr.tokens.RANGE?(n=this._getJS(e.nodeLeft),r=this._getJS(e.nodeRight),"amiTwig.stdlib.isInObject("+n+","+r+")"):(i=this._getJS(e.nodeLeft),n=e.nodeRight.nodeLeft.nodeValue,r=e.nodeRight.nodeRight.nodeValue,"amiTwig.stdlib.isInRange("+i+","+n+","+r+")");case amiTwig.expr.tokens.STARTS_WITH:return n=this._getJS(e.nodeLeft),r=this._getJS(e.nodeRight),"amiTwig.stdlib.startsWith("+n+","+r+")";case amiTwig.expr.tokens.ENDS_WITH:return n=this._getJS(e.nodeLeft),r=this._getJS(e.nodeRight),"amiTwig.stdlib.endsWith("+n+","+r+")";case amiTwig.expr.tokens.MATCHES:return n=this._getJS(e.nodeLeft),r=this._getJS(e.nodeRight),"amiTwig.stdlib.match("+n+","+r+")";case amiTwig.expr.tokens.RANGE:return n=this._getJS(e.nodeLeft),r=this._getJS(e.nodeRight),"amiTwig.stdlib.range("+n+","+r+")";case amiTwig.expr.tokens.DOT:return n=this._getJS(e.nodeLeft),r=this._getJS(e.nodeRight),"."===e.nodeValue[0]?n+"."+r:n+"["+r+"]";case amiTwig.expr.tokens.FLDIV:return n=this._getJS(e.nodeLeft),r=this._getJS(e.nodeRight),"Math.floor("+n+"/"+r+")";case amiTwig.expr.tokens.POWER:return n=this._getJS(e.nodeLeft),r=this._getJS(e.nodeRight),"Math.pow("+n+","+r+")";case amiTwig.expr.tokens.DOUBLE_QUESTION:return n=this._getJS(e.nodeLeft),r=this._getJS(e.nodeRight),"(("+n+") || ("+r+"))";default:if(null===e.nodeLeft&&null!==e.nodeRight)return(s=e.nodeType!==amiTwig.expr.tokens.NOT?e.nodeValue:"!")+"("+this._getJS(e.nodeRight)+")";if(null!==e.nodeLeft&&null===e.nodeRight)return s=e.nodeType!==amiTwig.expr.tokens.NOT?e.nodeValue:"!","("+this._getJS(e.nodeLeft)+")"+s;if(null!==e.nodeLeft&&null!==e.nodeRight){switch(e.nodeType){case amiTwig.expr.tokens.LOGICAL_OR:s="||";break;case amiTwig.expr.tokens.LOGICAL_AND:s="&&";break;case amiTwig.expr.tokens.BITWISE_OR:s="|";break;case amiTwig.expr.tokens.BITWISE_XOR:s="^";break;case amiTwig.expr.tokens.BITWISE_AND:s="&";break;case amiTwig.expr.tokens.CONCAT:s="+";break;default:s=e.nodeValue}return n=this._getJS(e.nodeLeft),r=this._getJS(e.nodeRight),"("+n+s+r+")"}}},getJS:function(e){return"(function(_) { return "+this._getJS(e.rootNode)+"; })"},eval:function(expr,_){return _=_||{},eval(this.getJS(expr)).call(_,_)}}}();