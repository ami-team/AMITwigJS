/*!
 * AMI TWIG Engine
 *
 * Copyright (c) 2014-2017 The AMI Team / LPSC / IN2P3
 *
 * This file must be used under the terms of the CeCILL-C:
 * http://www.cecill.info/licences/Licence_CeCILL-C_V1-en.html
 * http://www.cecill.info/licences/Licence_CeCILL-C_V1-fr.html
 *
 */

"use strict";var amiTwig={};"undefined"!=typeof exports&&(amiTwig.fs=require("fs"),module.exports.amiTwig=amiTwig),amiTwig.tokenizer={tokenize:function(e,i,t,r,n,s){if(r.length!==n.length)throw"`tokenDefs.length != tokenTypes.length`";var o=[],a=[],h=[],p=0,l=e.length,u="",c=void 0,k=void 0;e:for(;p<l;)if("\n"===(k=e.charAt(0))&&i++,t.indexOf(k)>=0){if(u){if(s)throw"invalid token `"+u+"`";o.push(u),a.push(-1),h.push(i),u=""}e=e.substring(1),p+=1}else{for(var g in r)if(c=this._match(e,r[g])){if(u){if(s)throw"invalid token `"+u+"`";o.push(u),a.push(-1),h.push(i),u=""}o.push(c),a.push(n[g]),h.push(i),e=e.substring(c.length),p+=c.length;continue e}u+=k,e=e.substring(1),p+=1}if(u){if(s)throw"invalid token `"+u+"`";o.push(u),a.push(-1),h.push(i),u=""}return{tokens:o,types:a,lines:h}},_match:function(e,i){var t=void 0;return i instanceof RegExp?null!==(t=e.match(i))&&this._checkNextChar(e,t[0])?t[0]:null:0===(t=e.indexOf(i))&&this._checkNextChar(e,i)?i:null},_alnum:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],_checkNextChar:function(e,i){var t=i.length,r=e.charCodeAt(t-0),n=e.charCodeAt(t-1);return isNaN(r)||0===this._alnum[r]||0===this._alnum[n]}},amiTwig.expr={},amiTwig.expr.tokens={$init:function(){this.IS_XXX=[this.DEFINED,this.NULL,this.EMPTY,this.ITERABLE,this.EVEN,this.ODD],this.XXX_WITH=[this.STARTS_WITH,this.ENDS_WITH],this.PLUS_MINUS=[this.CONCAT,this.PLUS,this.MINUS],this.MUL_FLDIV_DIV_MOD=[this.MUL,this.FLDIV,this.DIV,this.MOD],this.RX=[this.RP,this.RB1]},LOGICAL_OR:100,LOGICAL_AND:101,BITWISE_OR:102,BITWISE_XOR:103,BITWISE_AND:104,NOT:105,IS:106,DEFINED:107,NULL:108,EMPTY:109,ITERABLE:110,EVEN:111,ODD:112,CMP_OP:113,STARTS_WITH:114,ENDS_WITH:115,MATCHES:116,IN:117,RANGE:118,CONCAT:119,PLUS:120,MINUS:121,POWER:122,MUL:123,FLDIV:124,DIV:125,MOD:126,COLON:127,DOT:128,COMMA:129,PIPE:130,LP:131,RP:132,LB1:133,RB1:134,LB2:135,RB2:136,SID:137,TERMINAL:138,LST:200,DIC:201,FUN:202,VAR:203},amiTwig.expr.tokens.$init(),amiTwig.expr.Tokenizer=function(e,i){this._spaces=[" ","\t","\n","\r"],this._tokenDefs=["or","and","b-or","b-xor","b-and","not","is","defined","null","empty","iterable","even","odd","===","==","!==","!=","<=",">=","<",">",/^starts\s+with/,/^ends\s+with/,"matches","in","..","~","+","-","**","*","//","/","%",":",".",",","|","(",")","[","]","{","}","true","false",/^[0-9]+\.[0-9]+/,/^[0-9]+/,/^'(\\'|[^\'])*'/,/^"(\\"|[^\"])*"/,/^[a-zA-Z_$][a-zA-Z0-9_$]*/],this._tokenTypes=[amiTwig.expr.tokens.LOGICAL_OR,amiTwig.expr.tokens.LOGICAL_AND,amiTwig.expr.tokens.BITWISE_OR,amiTwig.expr.tokens.BITWISE_XOR,amiTwig.expr.tokens.BITWISE_AND,amiTwig.expr.tokens.NOT,amiTwig.expr.tokens.IS,amiTwig.expr.tokens.DEFINED,amiTwig.expr.tokens.NULL,amiTwig.expr.tokens.EMPTY,amiTwig.expr.tokens.ITERABLE,amiTwig.expr.tokens.EVEN,amiTwig.expr.tokens.ODD,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.STARTS_WITH,amiTwig.expr.tokens.ENDS_WITH,amiTwig.expr.tokens.MATCHES,amiTwig.expr.tokens.IN,amiTwig.expr.tokens.RANGE,amiTwig.expr.tokens.CONCAT,amiTwig.expr.tokens.PLUS,amiTwig.expr.tokens.MINUS,amiTwig.expr.tokens.POWER,amiTwig.expr.tokens.MUL,amiTwig.expr.tokens.FLDIV,amiTwig.expr.tokens.DIV,amiTwig.expr.tokens.MOD,amiTwig.expr.tokens.COLON,amiTwig.expr.tokens.DOT,amiTwig.expr.tokens.COMMA,amiTwig.expr.tokens.PIPE,amiTwig.expr.tokens.LP,amiTwig.expr.tokens.RP,amiTwig.expr.tokens.LB1,amiTwig.expr.tokens.RB1,amiTwig.expr.tokens.LB2,amiTwig.expr.tokens.RB2,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.SID],this.$init=function(e,i){var t=amiTwig.tokenizer.tokenize(e,i,this._spaces,this._tokenDefs,this._tokenTypes,!0);this.tokens=t.tokens,this.types=t.types,this.i=0},this.next=function(e){this.i+=e||1},this.isEmpty=function(){return this.i>=this.tokens.length},this.peekToken=function(){return this.tokens[this.i]},this.peekType=function(){return this.types[this.i]},this.checkType=function(e){if(this.i<this.tokens.length){var i=this.types[this.i];return e instanceof Array?e.indexOf(i)>=0:e===i}return!1},this.$init(e,i)},amiTwig.expr.Compiler=function(e,i){this.$init(e,i)},amiTwig.expr.Compiler.prototype={$init:function(e,i){if(this.tokenizer=new amiTwig.expr.Tokenizer(this.code=e,this.line=i),this.rootNode=this.parseFilter(),!1===this.tokenizer.isEmpty())throw"syntax error, line `"+this.line+"`, unexpected token `"+this.tokenizer.peekToken()+"`"},dump:function(){return this.rootNode.dump()},parseFilter:function(){for(var e=this.parseLogicalOr(),i=void 0,t=void 0;this.tokenizer.checkType(amiTwig.expr.tokens.PIPE);){for(this.tokenizer.next(),t=i=this.parseDot1(!0);t.nodeType===amiTwig.expr.tokens.DOT;t=t.nodeLeft);t.list.unshift(e),e=i}return e},parseLogicalOr:function(){for(var e=this.parseLogicalAnd(),i=void 0,t=void 0;this.tokenizer.checkType(amiTwig.expr.tokens.LOGICAL_OR);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),i=this.parseLogicalAnd(),t.nodeLeft=e,t.nodeRight=i,e=t;return e},parseLogicalAnd:function(){for(var e=this.parseBitwiseOr(),i=void 0,t=void 0;this.tokenizer.checkType(amiTwig.expr.tokens.LOGICAL_AND);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),i=this.parseBitwiseOr(),t.nodeLeft=e,t.nodeRight=i,e=t;return e},parseBitwiseOr:function(){for(var e=this.parseBitwiseXor(),i=void 0,t=void 0;this.tokenizer.checkType(amiTwig.expr.tokens.BITWISE_OR);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),i=this.parseBitwiseXor(),t.nodeLeft=e,t.nodeRight=i,e=t;return e},parseBitwiseXor:function(){for(var e=this.parseBitwiseAnd(),i=void 0,t=void 0;this.tokenizer.checkType(amiTwig.expr.tokens.BITWISE_XOR);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),i=this.parseBitwiseAnd(),t.nodeLeft=e,t.nodeRight=i,e=t;return e},parseBitwiseAnd:function(){for(var e=this.parseNot(),i=void 0,t=void 0;this.tokenizer.checkType(amiTwig.expr.tokens.BITWISE_AND);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),i=this.parseNot(),t.nodeLeft=e,t.nodeRight=i,e=t;return e},parseNot:function(){var e=void 0,i=void 0;return this.tokenizer.checkType(amiTwig.expr.tokens.NOT)?(i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseComp(),i.nodeLeft=e,i.nodeRight=null,i):this.parseComp()},parseComp:function(){var e=this.parseAddSub(),i=void 0,t=void 0,r=void 0;if(this.tokenizer.checkType(amiTwig.expr.tokens.IS)){if(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),r=t,this.tokenizer.checkType(amiTwig.expr.tokens.NOT)&&(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t.nodeLeft=r,t.nodeRight=null),!this.tokenizer.checkType(amiTwig.expr.tokens.IS_XXX))throw"syntax error, line `"+this.line+"`, keyword `defined`, `null`, `empty`, `iterable`, `even` or `odd` expected";i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),r.nodeLeft=e,r.nodeRight=i,e=t}else this.tokenizer.checkType(amiTwig.expr.tokens.CMP_OP)?(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),i=this.parseAddSub(),t.nodeLeft=e,t.nodeRight=i,e=t):this.tokenizer.checkType(amiTwig.expr.tokens.XXX_WITH)?(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),i=this.parseAddSub(),t.nodeLeft=e,t.nodeRight=i,e=t):this.tokenizer.checkType(amiTwig.expr.tokens.MATCHES)?(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),i=this.parseAddSub(),t.nodeLeft=e,t.nodeRight=i,e=t):this.tokenizer.checkType(amiTwig.expr.tokens.IN)&&(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),i=this.parseAddSub(),t.nodeLeft=e,t.nodeRight=i,e=t);return e},parseAddSub:function(){for(var e=this.parseMulDiv(),i=void 0,t=void 0;this.tokenizer.checkType(amiTwig.expr.tokens.PLUS_MINUS);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),i=this.parseMulDiv(),t.nodeLeft=e,t.nodeRight=i,e=t;return e},parseMulDiv:function(){for(var e=this.parsePlusMinus(),i=void 0,t=void 0;this.tokenizer.checkType(amiTwig.expr.tokens.MUL_FLDIV_DIV_MOD);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),i=this.parsePlusMinus(),t.nodeLeft=e,t.nodeRight=i,e=t;return e},parsePlusMinus:function(){var e=void 0,i=void 0;return this.tokenizer.checkType(amiTwig.expr.tokens.PLUS_MINUS)?(i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parsePower(),i.nodeLeft=e,i.nodeRight=null,i):this.parsePower()},parsePower:function(){for(var e=this.parseDot1(),i=void 0,t=void 0;this.tokenizer.checkType(amiTwig.expr.tokens.POWER);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),i=this.parseDot1(),t.nodeLeft=e,t.nodeRight=i,e=t;return e},parseDot1:function(e){var i=this.parseDot2(e);if(i){for(var t=i;t.nodeType===amiTwig.expr.tokens.DOT;t=t.nodeLeft);t.q&&(t.nodeType===amiTwig.expr.tokens.FUN?t.nodeValue in amiTwig.stdlib?t.nodeValue="amiTwig.stdlib."+t.nodeValue:t.nodeValue="_."+t.nodeValue:t.nodeType===amiTwig.expr.tokens.VAR&&(t.nodeValue="_."+t.nodeValue),t.q=!1)}return i},parseDot2:function(e){for(var i=this.parseDot3(e),t=void 0,r=void 0;this.tokenizer.checkType(amiTwig.expr.tokens.DOT);)r=new amiTwig.expr.Node(this.tokenizer.peekType(),"."),this.tokenizer.next(),t=this.parseDot3(e),r.nodeLeft=i,r.nodeRight=t,i=r;return i},parseDot3:function(e){for(var i=this.parseX(e),t=void 0,r=void 0;this.tokenizer.checkType(amiTwig.expr.tokens.LB1);){if(this.tokenizer.next(),t=this.parseFilter(),!this.tokenizer.checkType(amiTwig.expr.tokens.RB1))throw"syntax error, line `"+this.line+"`, `]` expected";this.tokenizer.next(),(r=new amiTwig.expr.Node(amiTwig.expr.tokens.DOT,"[]")).nodeLeft=i,r.nodeRight=t,i=r}return i},parseX:function(e){var i=void 0;if(i=this.parseGroup())return i;if(i=this.parseArray())return i;if(i=this.parseObject())return i;if(i=this.parseFunVar(e))return i;if(i=this.parseTerminal())return i;throw"syntax error, line `"+this.line+"`, syntax error or tuncated expression"},parseGroup:function(){var e=void 0;if(this.tokenizer.checkType(amiTwig.expr.tokens.LP)){if(this.tokenizer.next(),e=this.parseFilter(),this.tokenizer.checkType(amiTwig.expr.tokens.RP))return this.tokenizer.next(),e;throw"syntax error, line `"+this.line+"`, `)` expected"}return null},parseArray:function(){var e=void 0,i=void 0;if(this.tokenizer.checkType(amiTwig.expr.tokens.LB1)){if(this.tokenizer.next(),i=this._parseSinglets(),this.tokenizer.checkType(amiTwig.expr.tokens.RB1))return this.tokenizer.next(),e=new amiTwig.expr.Node(amiTwig.expr.tokens.LST,"Array"),e.list=i,e;throw"syntax error, line `"+this.line+"`, `]` expected"}return null},parseObject:function(){var e=void 0,i=void 0;if(this.tokenizer.checkType(amiTwig.expr.tokens.LB2)){if(this.tokenizer.next(),i=this._parseDoublets(),this.tokenizer.checkType(amiTwig.expr.tokens.RB2))return this.tokenizer.next(),e=new amiTwig.expr.Node(amiTwig.expr.tokens.DIC,"Object"),e.dict=i,e;throw"syntax error, line `"+this.line+"`, `}` expected"}return null},parseFunVar:function(e){var i=void 0;if(this.tokenizer.checkType(amiTwig.expr.tokens.SID)){if(i=new amiTwig.expr.Node(0,e?"filter_"+this.tokenizer.peekToken():this.tokenizer.peekToken()),i.q=!0,this.tokenizer.next(),this.tokenizer.checkType(amiTwig.expr.tokens.LP)){if(this.tokenizer.next(),i.list=this._parseSinglets(),!this.tokenizer.checkType(amiTwig.expr.tokens.RP))throw"syntax error, line `"+this.line+"`, `)` expected";this.tokenizer.next(),i.nodeType=amiTwig.expr.tokens.FUN}else i.nodeType=e?amiTwig.expr.tokens.FUN:amiTwig.expr.tokens.VAR,i.list=[];return i}return null},_parseSinglets:function(){for(var e=[];!1===this.tokenizer.checkType(amiTwig.expr.tokens.RX)&&(this._parseSinglet(e),!0===this.tokenizer.checkType(amiTwig.expr.tokens.COMMA));)this.tokenizer.next();return e},_parseDoublets:function(){for(var e={};!1===this.tokenizer.checkType(amiTwig.expr.tokens.RB2)&&(this._parseDoublet(e),!0===this.tokenizer.checkType(amiTwig.expr.tokens.COMMA));)this.tokenizer.next();return e},_parseSinglet:function(e){e.push(this.parseFilter())},_parseDoublet:function(e){if(!this.tokenizer.checkType(amiTwig.expr.tokens.TERMINAL))throw"syntax error, line `"+this.line+"`, terminal expected";var i=this.tokenizer.peekToken();if(this.tokenizer.next(),!this.tokenizer.checkType(amiTwig.expr.tokens.COLON))throw"syntax error, line `"+this.line+"`, `:` expected";this.tokenizer.next(),e[i]=this.parseFilter()},parseTerminal:function(){var e=void 0,i=void 0,t=void 0;if(this.tokenizer.checkType(amiTwig.expr.tokens.TERMINAL)){if(e=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),!this.tokenizer.checkType(amiTwig.expr.tokens.RANGE))return e;if(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),this.tokenizer.checkType(amiTwig.expr.tokens.TERMINAL))return i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t.nodeLeft=e,t.nodeRight=i,t}return null}},amiTwig.expr.Node=function(e,i){this.$init(e,i)},amiTwig.expr.Node.prototype={$init:function(e,i){this.nodeType=e,this.nodeValue=i,this.nodeLeft=null,this.nodeRight=null,this.list=null,this.dict=null},_dump:function(e,i,t){var r=void 0,n=t[0];if(e.push("\tnode"+n+' [label="'+this.nodeValue.replace(/"/g,'\\"')+'"];'),this.nodeLeft&&(r=++t[0],i.push("\tnode"+n+" -> node"+r+";"),this.nodeLeft._dump(e,i,t)),this.nodeRight&&(r=++t[0],i.push("\tnode"+n+" -> node"+r+";"),this.nodeRight._dump(e,i,t)),this.list)for(var s in this.list)r=++t[0],i.push("\tnode"+n+" -> node"+r+' [label="['+s.replace(/"/g,'\\"')+']"];'),this.list[s]._dump(e,i,t);if(this.dict)for(var o in this.dict)r=++t[0],i.push("\tnode"+n+" -> node"+r+' [label="['+o.replace(/"/g,'\\"')+']"];'),this.dict[o]._dump(e,i,t)},dump:function(){var e=[],i=[];return this._dump(e,i,[0]),"digraph ast {\n\trankdir=TB;\n"+e.join("\n")+"\n"+i.join("\n")+"\n}"}},amiTwig.tmpl={},amiTwig.tmpl.Compiler=function(e){this.$init(e)},amiTwig.tmpl.Compiler.prototype={STATEMENT_RE:/\{%\s*([a-zA-Z]+)\s+(.*?)\s*%\}/m,COMMENT_RE:/\{#\s*(.*?)\s*#\}/g,$init:function(e){var i=1,t=0,r=0;this.rootNode={line:i,keyword:"@root",expression:"",blocks:[{expression:"@root",list:[]}],value:""};var n=[this.rootNode],s=[0],o=void 0;for(e=e.replace(this.COMMENT_RE,"");;e=e.substr(r)){var a=n[n.length-1],h=s[s.length-1],p=e.match(this.STATEMENT_RE);if(null===p){var l=!0,u=!1,c=void 0;try{for(var k,g=e[Symbol.iterator]();!(l=(k=g.next()).done);l=!0)"\n"===k.value&&i++}catch(e){u=!0,c=e}finally{try{!l&&g.return&&g.return()}finally{if(u)throw c}}a.blocks[h].list.push({line:i,keyword:"@text",expression:"",blocks:[],value:e});for(var d=[],T=n.length-1;T>0;T--)"if"===n[T].keyword?d.push("missing keyword `endif`"):"for"===n[T].keyword&&d.push("missing keyword `endfor`");if(d.length>0)throw"syntax error, line `"+i+"`, "+d.join(", ");return}var f=p[0],w=p[1],x=p[2];t=p.index+0,r=p.index+f.length;var m=e.substr(0,t),v=e.substr(0,r);for(var y in v)"\n"===y&&i++;switch(m&&(o={line:i,keyword:"@text",expression:"",blocks:[],value:m},a.blocks[h].list.push(o)),w){case"flush":case"autoescape":case"spaceless":case"verbatim":break;case"do":case"set":case"include":o={line:i,keyword:w,expression:x,blocks:[],value:""},a.blocks[h].list.push(o);break;case"if":case"for":o={line:i,keyword:w,blocks:[{expression:x,list:[]}],value:""},a.blocks[h].list.push(o),n.push(o),s.push(0);break;case"elseif":if("if"!==a.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `elseif`";h=a.blocks.length,a.blocks.push({expression:x,list:[]}),s[s.length-1]=h;break;case"else":if("if"!==a.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `else`";h=a.blocks.length,a.blocks.push({expression:"@else",list:[]}),s[s.length-1]=h;break;case"endif":if("if"!==a.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `endif`";n.pop(),s.pop();break;case"endfor":if("for"!==a.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `endfor`";n.pop(),s.pop();break;default:throw"syntax error, line `"+i+"`, unknown keyword `"+w+"`"}}},dump:function(){return JSON.stringify(this.rootNode,null,2)}},amiTwig.engine={VARIABLE_RE:/\{\{\s*(.*?)\s*\}\}/g,_render:function(e,i,t){var r=void 0,n=void 0,s=void 0,o=void 0,a=void 0,h=void 0,p=void 0,l=void 0;switch(this.dict=t||{},i.keyword){case"do":amiTwig.expr.cache.eval(i.expression,i.line,t);break;case"set":if(!(a=i.expression.match(/([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*(.+)/)))throw"syntax error, line `"+i.line+"`, invalid `set` statement";t[a[1]]=amiTwig.expr.cache.eval(a[2],i.line,t);break;case"@text":e.push(i.value.replace(this.VARIABLE_RE,function(e,r){return void 0!==(l=amiTwig.expr.cache.eval(r,i.line,t))&&null!==l?l:""}));break;case"if":case"@root":for(var u in i.blocks)if("@root"===(s=i.blocks[u].expression)||"@else"===s||amiTwig.expr.cache.eval(s,i.line,t)){o=i.blocks[u].list;for(var c in o)this._render(e,o[c],t);break}break;case"for":if(!(a=i.blocks[0].expression.match(/([a-zA-Z_$][a-zA-Z0-9_$]*)\s+in\s+(.+)/)))throw"syntax error, line `"+i.line+"`, invalid `for` statement";h=a[1],p=a[2],l=amiTwig.expr.cache.eval(p,i.line,t);var k=Object.prototype.toString.call(l);if("[object Array]"!==k&&"[object Object]"!==k&&"[object String]"!==k)throw"syntax error, line `"+i.line+"`, right operande not iterable";"[object Object]"===k&&(l=Object.keys(l));var g=t[h],d=t.loop;r=0,n=l.length,t.loop={length:n},o=i.blocks[0].list;for(var T in l){t[h]=l[T],t.loop.first=0===r,t.loop.last=r===n-1,t.loop.index0=r,r++,t.loop.index=r;for(var f in o)this._render(e,o[f],t)}d&&(t.loop=d),g&&(t[h]=g);break;case"include":var w=!0;(a=(s=(s=i.expression).trim()).match(/only$/))&&(s=s.substr(s,s.length-a[0].length-1),w=!1);var x="{}";(a=(s=s.trim()).match(/with\s+(.+)$/))&&(s=s.substr(s,s.length-a[0].length-1),x=a[1]);var m=amiTwig.expr.cache.eval(s,i.line,t)||"";if("[object String]"!==Object.prototype.toString.call(m))throw"runtime error, line `"+i.line+"`, string expected";var v=amiTwig.expr.cache.eval(x,i.line,t)||{};if("[object Object]"!==Object.prototype.toString.call(v))throw"runtime error, line `"+i.line+"`, object expected";e.push(amiTwig.stdlib.include(m,v,w,!1))}},render:function(e,i){var t=[];return this._render(t,"[object String]"===Object.prototype.toString.call(e)?new amiTwig.tmpl.Compiler(e).rootNode:e,i||{}),t.join("")}},amiTwig.expr.cache={dict:{},eval:function _eval(expression,line,_){var f=void 0;return f=expression in this.dict?this.dict[expression]:this.dict[expression]=eval(amiTwig.expr.interpreter.getJS(new amiTwig.expr.Compiler(expression,line))),_||(_={}),f.call(_,_)}},amiTwig.ajax={dict:{},get:function(e,i,t){var r=void 0;if(e in this.dict)i&&i(this.dict[e]);else if(amiTwig.fs)try{r=this.dict[e]=amiTwig.fs.readFileSync(e,"utf8"),i&&i(r)}catch(e){t&&t(e)}else{var n=new XMLHttpRequest;n.open("GET",e,!1),n.send(),200===n.status?(r=this.dict[e]=n.responseText,i&&i(r)):(r=n.responseText,t&&t(r))}}},amiTwig.stdlib={isUndefined:function(e){return void 0===e},isDefined:function(e){return void 0!==e},isNull:function(e){return null===e},isNotNull:function(e){return null!==e},isEmpty:function(e){if(null===e||!1===e||""===e)return!0;var i=Object.prototype.toString.call(e);return"[object Array]"===i&&0===e.length||"[object Object]"===i&&0===Object.keys(e).length},isNumber:function(e){return"[object Number]"===Object.prototype.toString.call(e)},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},isObject:function(e){return"[object Object]"===Object.prototype.toString.call(e)},isIterable:function(e){var i=Object.prototype.toString.call(e);return"[object String]"===i||"[object Array]"===i||"[object Object]"===i},isEven:function(e){return this.isNumber(e)&&0==(1&e)},isOdd:function(e){return this.isNumber(e)&&1==(1&e)},isInObject:function(e,i){return this.isArray(i)||this.isString(i)?i.indexOf(e)>=0:!!this.isObject(i)&&e in i},isInRange:function(e,i,t){return this.isNumber(i)&&this.isNumber(t)?e>=i&&e<=t:!(!this.isString(i)||1!==i.length||!this.isString(t)||1!==t.length)&&(e.charCodeAt(0)>=i.charCodeAt(0)&&e.charCodeAt(0)<=t.charCodeAt(0))},range:function(e,i,t){t||(t=1);var r=[];if(this.isNumber(e)&&this.isNumber(i))for(var n=e;n<=i;n+=t)r.push(n);else if(this.isString(e)&&1===e.length&&this.isString(i)&&1===i.length)for(var s=e.charCodeAt(0);s<=i.charCodeAt(0);s+=t)r.push(String.fromCharCode(s));return r},filter_length:function(e){return this.isString(e)||this.isArray(e)?e.length:this.isObject(e)?Object.keys(e).length:0},filter_first:function(e){return(this.isString(e)||this.isArray(e))&&e.length>0?e[0]:""},filter_last:function(e){return(this.isString(e)||this.isArray(e))&&e.length>0?e[e.length-1]:""},filter_slice:function(e,i,t){return this.isString(e)||this.isArray(e)?e.slice(i,t):null},filter_merge:function(){if(arguments.length>1){if(this.isString(arguments[0])){var e=[];for(var i in arguments){var t=arguments[i];if(!this.isString(t))return null;e.push(arguments[i])}return e.join("")}if(this.isArray(arguments[0])){var r=[];for(var n in arguments){var s=arguments[n];if(!this.isArray(s))return null;for(var o in s)r.push(s[o])}return r}if(this.isObject(arguments[0])){var a={};for(var h in arguments){var p=arguments[h];if(!this.isObject(p))return null;for(var l in p)a[l]=p[l]}return a}}return null},filter_sort:function(e){return this.isArray(e)?e.sort():[]},filter_reverse:function(e){return this.isArray(e)?e.reverse():[]},filter_join:function(e,i){return this.isArray(e)?e.join(i):""},filter_keys:function(e){return this.isObject(e)?Object.keys(e):[]},startsWith:function(e,i){if(this.isString(e)&&this.isString(i)){return 0===e.indexOf(i,0)}return!1},endsWith:function(e,i){if(this.isString(e)&&this.isString(i)){var t=e.length-i.length;return e.indexOf(i,t)===t}return!1},match:function(e,i){if(this.isString(e)&&this.isString(i)){var t=i.indexOf("/"),r=i.lastIndexOf("/");if(0===t||t<r)try{return new RegExp(i.substring(t+1,r),i.substring(r+1)).test(e)}catch(e){}}return!1},filter_default:function(e,i){return e||i||""},filter_lower:function(e){return this.isString(e)?e.toLowerCase():""},filter_upper:function(e){return this.isString(e)?e.toUpperCase():""},filter_capitalize:function(e){return this.isString(e)?e.trim().toLowerCase().replace(/^\S/g,function(e){return e.toUpperCase()}):""},filter_title:function(e){return this.isString(e)?e.trim().toLowerCase().replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()}):""},filter_trim:function(e){return this.isString(e)?e.trim():""},_replace:function(e,i,t){var r=[],n=e.length;e:for(var s=0;s<n;){for(var o in i)if(0===e.substring(s).indexOf(i[o])){r.push(t[o]),s+=i[o].length;continue e}r.push(e.charAt(s++))}return r.join("")},_textToHtmlX:["&",'"',"<",">"],_textToHtmlY:["&amp;","&quot;","&lt;","&gt;"],_textToStringX:["\\","\n",'"',"'"],_textToStringY:["\\\\","\\n",'\\"',"\\'"],filter_escape:function(e,i){if(this.isString(e))switch(i||"html"){case"html":case"html_attr":return this._replace(e,this._textToHtmlX,this._textToHtmlY);case"js":case"string":return this._replace(e,this._textToStringX,this._textToStringY);case"url":return encodeURIComponent(e);default:return e}return""},filter_url_encode:function(e){return this.isString(e)?encodeURIComponent(e):""},filter_nl2br:function(e){return this.isString(e)?e.replace(/\n/g,"<br/>"):""},filter_raw:function(e){return this.isString(e)?e:""},filter_replace:function(e,i){var t=[];if(this.isString(e)&&this.isObject(i)){var r=0,n=e.length;e:for(;r<n;){for(var s in i)if(0===e.substring(r).indexOf(s)){t.push(i[s]),r+=s.length;continue e}t.push(e.charAt(r++))}}return t.join("")},filter_split:function(e,i,t){return this.isString(e)?e.split(i,t):[]},filter_abs:function(e){return Math.abs(e)},filter_round:function(e,i){switch(i){case"ceil":return Math.ceil(e);case"floor":return Math.floor(e);default:return Math.round(e)}},min:function(){var e=1===arguments.length&&(this.isArray(arguments[0])||this.isObject(arguments[0]))?arguments[0]:arguments,i=Number.POSITIVE_INFINITY,t=!0,r=!1,n=void 0;try{for(var s,o=e[Symbol.iterator]();!(t=(s=o.next()).done);t=!0){var a=s.value;if(!this.isNumber(a))return Number.NaN;i>a&&(i=a)}}catch(e){r=!0,n=e}finally{try{!t&&o.return&&o.return()}finally{if(r)throw n}}return i},max:function(){var e=1===arguments.length&&(this.isArray(arguments[0])||this.isObject(arguments[0]))?arguments[0]:arguments,i=Number.NEGATIVE_INFINITY,t=!0,r=!1,n=void 0;try{for(var s,o=e[Symbol.iterator]();!(t=(s=o.next()).done);t=!0){var a=s.value;if(!this.isNumber(a))return Number.NaN;i<a&&(i=a)}}catch(e){r=!0,n=e}finally{try{!t&&o.return&&o.return()}finally{if(r)throw n}}return i},random:function(e){var i=Math.random();if(e){if(this.isString(e)||this.isArray(e))return e[Math.floor(e.length*i)];if(this.isNumber(e))return Math.floor(e*i)}return e=Number.MAX_SAFE_INTEGER,Math.floor(e*i)},filter_json_encode:function(e){return JSON.stringify(e,null,2)},filter_json_jspath:function(e,i){return"undefined"!=typeof JSPath?JSPath.apply(i,e):[]},include:function(e,i,t,r){var n={};if(t)for(var s in amiTwig.engine.dict)n[s]=amiTwig.engine.dict[s];if(i)for(var o in i)n[o]=i[o];var a="";return amiTwig.ajax.get(e,function(e){a=amiTwig.engine.render(e,n)},function(){if(!r)throw"runtime error, could not open `"+e+"`"}),a}},amiTwig.stdlib.filter_e=amiTwig.stdlib.filter_escape,amiTwig.expr.interpreter={_getJS:function(e){var i=void 0,t=void 0,r=void 0,n=void 0,s=void 0;switch(e.nodeType){case amiTwig.expr.tokens.LST:i=[];for(var o in e.list)i.push(this._getJS(e.list[o]));return"["+i.join(",")+"]";case amiTwig.expr.tokens.DIC:i=[];for(var a in e.dict)i.push(a+":"+this._getJS(e.dict[a]));return"{"+i.join(",")+"}";case amiTwig.expr.tokens.FUN:i=[];for(var h in e.list)i.push(this._getJS(e.list[h]));return e.nodeValue+"("+i.join(",")+")";case amiTwig.expr.tokens.VAR:i=[];for(var p in e.list)i.push("["+this._getJS(e.list[p])+"]");return i.length>0?e.nodeValue+i.join(""):e.nodeValue;case amiTwig.expr.tokens.TERMINAL:return e.nodeValue;case amiTwig.expr.tokens.IS:switch(r=this._getJS(e.nodeLeft),e.nodeRight.nodeType){case amiTwig.expr.tokens.DEFINED:return"amiTwig.stdlib.isDefined("+r+")";case amiTwig.expr.tokens.NULL:return"amiTwig.stdlib.isNull("+r+")";case amiTwig.expr.tokens.EMPTY:return"amiTwig.stdlib.isEmpty("+r+")";case amiTwig.expr.tokens.ITERABLE:return"amiTwig.stdlib.isIterable("+r+")";case amiTwig.expr.tokens.EVEN:return"amiTwig.stdlib.isEven("+r+")";case amiTwig.expr.tokens.ODD:return"amiTwig.stdlib.isOdd("+r+")";default:throw"internal error"}case amiTwig.expr.tokens.IN:return e.nodeRight.nodeType!==amiTwig.expr.tokens.RANGE?(r=this._getJS(e.nodeLeft),n=this._getJS(e.nodeRight),"amiTwig.stdlib.isInObject("+r+","+n+")"):(t=this._getJS(e.nodeLeft),r=e.nodeRight.nodeLeft.nodeValue,n=e.nodeRight.nodeRight.nodeValue,"amiTwig.stdlib.isInRange("+t+","+r+","+n+")");case amiTwig.expr.tokens.STARTS_WITH:return r=this._getJS(e.nodeLeft),n=this._getJS(e.nodeRight),"amiTwig.stdlib.startsWith("+r+","+n+")";case amiTwig.expr.tokens.ENDS_WITH:return r=this._getJS(e.nodeLeft),n=this._getJS(e.nodeRight),"amiTwig.stdlib.endsWith("+r+","+n+")";case amiTwig.expr.tokens.MATCHES:return r=this._getJS(e.nodeLeft),n=this._getJS(e.nodeRight),"amiTwig.stdlib.match("+r+","+n+")";case amiTwig.expr.tokens.RANGE:return r=this._getJS(e.nodeLeft),n=this._getJS(e.nodeRight),"amiTwig.stdlib.range("+r+","+n+")";case amiTwig.expr.tokens.DOT:return r=this._getJS(e.nodeLeft),n=this._getJS(e.nodeRight),"."===e.nodeValue[0]?r+"."+n:r+"["+n+"]";case amiTwig.expr.tokens.FLDIV:return r=this._getJS(e.nodeLeft),n=this._getJS(e.nodeRight),"Math.floor("+r+"/"+n+")";case amiTwig.expr.tokens.POWER:return r=this._getJS(e.nodeLeft),n=this._getJS(e.nodeRight),"Math.pow("+r+","+n+")";default:if(null!==e.nodeLeft&&null===e.nodeRight)return(s=e.nodeType!==amiTwig.expr.tokens.NOT?e.nodeValue:"!")+"("+this._getJS(e.nodeLeft)+")";if(null===e.nodeLeft&&null!==e.nodeRight)return s=e.nodeType!==amiTwig.expr.tokens.NOT?e.nodeValue:"!","("+this._getJS(e.nodeRight)+")"+s;if(null!==e.nodeLeft&&null!==e.nodeRight){switch(e.nodeType){case amiTwig.expr.tokens.LOGICAL_OR:s="||";break;case amiTwig.expr.tokens.LOGICAL_AND:s="&&";break;case amiTwig.expr.tokens.BITWISE_OR:s="|";break;case amiTwig.expr.tokens.BITWISE_XOR:s="^";break;case amiTwig.expr.tokens.BITWISE_AND:s="&";break;case amiTwig.expr.tokens.CONCAT:s="+";break;default:s=e.nodeValue}return r=this._getJS(e.nodeLeft),n=this._getJS(e.nodeRight),"("+r+s+n+")"}}},getJS:function(e){return"(function(_) { return "+this._getJS(e.rootNode)+"; })"},eval:function _eval(expr,_){return _||(_={}),eval(this.getJS(expr)).call(_,_)}};