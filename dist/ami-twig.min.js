/*!
 * Copyright © 2021-2021 CNRS/LPSC
 *
 * Author: Jérôme ODIER (jerome.odier@lpsc.in2p3.fr)
 *
 * Repositories: https://gitlab.in2p3.fr/ami-team/AMITwigJS/
 *               https://www.github.com/ami-team/AMITwigJS/
 *
 * This software is a computer program whose purpose is to provide a
 * JavaScript implementation for both NodeJS and browsers of the
 * SensioLabs's TWIG template engine.
 *
 * This software is governed by the CeCILL-C license under French law and
 * abiding by the rules of distribution of free software. You can use,
 * modify and/or redistribute the software under the terms of the CeCILL-C
 * license as circulated by CEA, CNRS and INRIA at the following URL
 * "http://www.cecill.info".
 *
 * The fact that you are presently reading this means that you have had
 * knowledge of the CeCILL-C license and that you accept its terms.
 *
 */
function _createForOfIteratorHelperLoose(e,i){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(t)return(t=t.call(e)).next.bind(t);if(Array.isArray(e)||(t=_unsupportedIterableToArray(e))||i&&e&&"number"==typeof e.length){t&&(e=t);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,i){if(e){if("string"==typeof e)return _arrayLikeToArray(e,i);var t=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(t="Object"===t&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,i):void 0}}function _arrayLikeToArray(e,i){(null==i||i>e.length)&&(i=e.length);for(var t=0,r=new Array(i);t<i;t++)r[t]=e[t];return r}!function(){"use strict";var amiTwig={version:"1.2.0"};"object"==typeof module&&"object"==typeof module.exports?module.exports.amiTwig=amiTwig:"function"==typeof define&&(define.amd||define.cmd)?define("amiTwig",function(){return amiTwig}):"undefined"!=typeof window?window.amiTwig=amiTwig:"undefined"!=typeof global&&(global.amiTwig=amiTwig),amiTwig.tokenizer={tokenize:function(e,i,t,r,n,s){if(r.length!==n.length)throw"`tokenDefs.length != tokenTypes.length`";var o,a,h=[],p=[],l=[],u=0,c=e.length,g="";e:for(;u<c;)if("\n"===(a=e.charAt(0))&&i++,0<=t.indexOf(a)){if(g){if(s)throw"invalid token `"+g+"`";h.push(g),p.push(-1),l.push(i),g=""}e=e.substring(1),u+=1}else{for(var k in r)if(o=this._match(e,r[k])){if(g){if(s)throw"invalid token `"+g+"`";h.push(g),p.push(-1),l.push(i),g=""}h.push(o),p.push(n[k]),l.push(i),e=e.substring(o.length),u+=o.length;continue e}g+=a,e=e.substring(1),u+=1}if(g){if(s)throw"invalid token `"+g+"`";h.push(g),p.push(-1),l.push(i)}return{tokens:h,types:p,lines:l}},_match:function(e,i){var t;return i instanceof RegExp?null!==(t=e.match(i))&&this._checkNextChar(e,t[0])?t[0]:null:0===(t=e.indexOf(i))&&this._checkNextChar(e,i)?i:null},_alnum:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],_checkNextChar:function(e,i){var t=i.length,i=e.charCodeAt(+t),t=e.charCodeAt(t-1);return isNaN(i)||0===this._alnum[i]||0===this._alnum[t]}},amiTwig.expr={},amiTwig.expr.tokens={$init:function(){this.IS_XXX=[this.DEFINED,this.NULL,this.EMPTY,this.ITERABLE,this.EVEN,this.ODD],this.XXX_WITH=[this.STARTS_WITH,this.ENDS_WITH],this.PLUS_MINUS=[this.CONCAT,this.PLUS,this.MINUS],this.MUL_FLDIV_DIV_MOD=[this.MUL,this.FLDIV,this.DIV,this.MOD],this.RX=[this.RP,this.RB1]},LOGICAL_OR:100,LOGICAL_AND:101,BITWISE_OR:102,BITWISE_XOR:103,BITWISE_AND:104,NOT:105,IS:106,DEFINED:107,NULL:108,EMPTY:109,ITERABLE:110,EVEN:111,ODD:112,CMP_OP:113,STARTS_WITH:114,ENDS_WITH:115,MATCHES:116,IN:117,RANGE:118,CONCAT:119,PLUS:120,MINUS:121,POWER:122,MUL:123,FLDIV:124,DIV:125,MOD:126,DOUBLE_QUESTION:127,QUESTION:128,COLON:129,DOT:130,COMMA:131,PIPE:132,LP:133,RP:134,LB1:135,RB1:136,LB2:137,RB2:138,SID:139,TERMINAL:140,LST:200,DIC:201,FUN:202,VAR:203},amiTwig.expr.tokens.$init(),amiTwig.expr.Tokenizer=function(e,i){this._spaces=[" ","\t","\n","\r"],this._tokenDefs=["or","and","b-or","b-xor","b-and","not","is","defined","null","empty","iterable","even","odd","===","==","!==","!=","<=",">=","<",">",/^starts\s+with/,/^ends\s+with/,"matches","in","..","~","+","-","**","*","//","/","%","??","?",":",".",",","|","(",")","[","]","{","}","true","false",/^[0-9]+\.[0-9]+/,/^[0-9]+/,/^'(\\'|[^'])*'/,/^"(\\"|[^"])*"/,/^[a-zA-Z_$][a-zA-Z0-9_$]*/],this._tokenTypes=[amiTwig.expr.tokens.LOGICAL_OR,amiTwig.expr.tokens.LOGICAL_AND,amiTwig.expr.tokens.BITWISE_OR,amiTwig.expr.tokens.BITWISE_XOR,amiTwig.expr.tokens.BITWISE_AND,amiTwig.expr.tokens.NOT,amiTwig.expr.tokens.IS,amiTwig.expr.tokens.DEFINED,amiTwig.expr.tokens.NULL,amiTwig.expr.tokens.EMPTY,amiTwig.expr.tokens.ITERABLE,amiTwig.expr.tokens.EVEN,amiTwig.expr.tokens.ODD,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.STARTS_WITH,amiTwig.expr.tokens.ENDS_WITH,amiTwig.expr.tokens.MATCHES,amiTwig.expr.tokens.IN,amiTwig.expr.tokens.RANGE,amiTwig.expr.tokens.CONCAT,amiTwig.expr.tokens.PLUS,amiTwig.expr.tokens.MINUS,amiTwig.expr.tokens.POWER,amiTwig.expr.tokens.MUL,amiTwig.expr.tokens.FLDIV,amiTwig.expr.tokens.DIV,amiTwig.expr.tokens.MOD,amiTwig.expr.tokens.DOUBLE_QUESTION,amiTwig.expr.tokens.QUESTION,amiTwig.expr.tokens.COLON,amiTwig.expr.tokens.DOT,amiTwig.expr.tokens.COMMA,amiTwig.expr.tokens.PIPE,amiTwig.expr.tokens.LP,amiTwig.expr.tokens.RP,amiTwig.expr.tokens.LB1,amiTwig.expr.tokens.RB1,amiTwig.expr.tokens.LB2,amiTwig.expr.tokens.RB2,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.SID],this.$init=function(e,i){i=amiTwig.tokenizer.tokenize(e,i,this._spaces,this._tokenDefs,this._tokenTypes,!0);this.tokens=i.tokens,this.types=i.types,this.i=0},this.next=function(e){this.i+=e=void 0===e?1:e},this.isEmpty=function(){return this.i>=this.tokens.length},this.peekToken=function(){return this.tokens[this.i]},this.peekType=function(){return this.types[this.i]},this.checkType=function(e){if(this.i<this.tokens.length){var i=this.types[this.i];return e instanceof Array?0<=e.indexOf(i):e===i}return!1},this.$init(e,i)},amiTwig.expr.Compiler=function(e,i){this.$init(e,i)},amiTwig.expr.Compiler.prototype={$init:function(e,i){if(this.tokenizer=new amiTwig.expr.Tokenizer(this.code=e,this.line=i),this.rootNode=this.parseNullCoalescing(),!1===this.tokenizer.isEmpty())throw"syntax error, line `"+this.line+"`, unexpected token `"+this.tokenizer.peekToken()+"`"},dump:function(){return this.rootNode.dump()},parseNullCoalescing:function(){for(var e,i,t=this.parseLogicalOr();this.tokenizer.checkType(amiTwig.expr.tokens.DOUBLE_QUESTION);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseLogicalOr(),i.nodeLeft=t,i.nodeRight=e,t=i;return t},parseLogicalOr:function(){for(var e,i,t=this.parseLogicalAnd();this.tokenizer.checkType(amiTwig.expr.tokens.LOGICAL_OR);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseLogicalAnd(),i.nodeLeft=t,i.nodeRight=e,t=i;return t},parseLogicalAnd:function(){for(var e,i,t=this.parseBitwiseOr();this.tokenizer.checkType(amiTwig.expr.tokens.LOGICAL_AND);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseBitwiseOr(),i.nodeLeft=t,i.nodeRight=e,t=i;return t},parseBitwiseOr:function(){for(var e,i,t=this.parseBitwiseXor();this.tokenizer.checkType(amiTwig.expr.tokens.BITWISE_OR);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseBitwiseXor(),i.nodeLeft=t,i.nodeRight=e,t=i;return t},parseBitwiseXor:function(){for(var e,i,t=this.parseBitwiseAnd();this.tokenizer.checkType(amiTwig.expr.tokens.BITWISE_XOR);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseBitwiseAnd(),i.nodeLeft=t,i.nodeRight=e,t=i;return t},parseBitwiseAnd:function(){for(var e,i,t=this.parseNot();this.tokenizer.checkType(amiTwig.expr.tokens.BITWISE_AND);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseNot(),i.nodeLeft=t,i.nodeRight=e,t=i;return t},parseNot:function(){var e,i;return this.tokenizer.checkType(amiTwig.expr.tokens.NOT)?(i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseComp(),i.nodeLeft=null,i.nodeRight=e,i):this.parseComp()},parseComp:function(){var e,i,t,r=this.parseAddSub();if(this.tokenizer.checkType(amiTwig.expr.tokens.IS)){if(i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t=i,this.tokenizer.checkType(amiTwig.expr.tokens.NOT)&&(i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),i.nodeLeft=null,i.nodeRight=t),!this.tokenizer.checkType(amiTwig.expr.tokens.IS_XXX))throw"syntax error, line `"+this.line+"`, keyword `defined`, `null`, `empty`, `iterable`, `even` or `odd` expected";e=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t.nodeLeft=r,t.nodeRight=e,r=i}else(this.tokenizer.checkType(amiTwig.expr.tokens.CMP_OP)||this.tokenizer.checkType(amiTwig.expr.tokens.XXX_WITH)||this.tokenizer.checkType(amiTwig.expr.tokens.MATCHES)||this.tokenizer.checkType(amiTwig.expr.tokens.IN))&&(i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseAddSub(),i.nodeLeft=r,i.nodeRight=e,r=i);return r},parseAddSub:function(){for(var e,i,t=this.parseMulDiv();this.tokenizer.checkType(amiTwig.expr.tokens.PLUS_MINUS);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseMulDiv(),i.nodeLeft=t,i.nodeRight=e,t=i;return t},parseMulDiv:function(){for(var e,i,t=this.parsePlusMinus();this.tokenizer.checkType(amiTwig.expr.tokens.MUL_FLDIV_DIV_MOD);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parsePlusMinus(),i.nodeLeft=t,i.nodeRight=e,t=i;return t},parsePlusMinus:function(){var e,i;return this.tokenizer.checkType(amiTwig.expr.tokens.PLUS_MINUS)?(i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parsePower(),i.nodeLeft=null,i.nodeRight=e,i):this.parsePower()},parsePower:function(){for(var e,i,t=this.parseFilter();this.tokenizer.checkType(amiTwig.expr.tokens.POWER);)i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseFilter(),i.nodeLeft=t,i.nodeRight=e,t=i;return t},parseFilter:function(){for(var e,i,t=this.parseDot1();this.tokenizer.checkType(amiTwig.expr.tokens.PIPE);){for(this.tokenizer.next(),i=e=this.parseDot1(!0);i.nodeType===amiTwig.expr.tokens.DOT;i=i.nodeLeft);i.list.unshift(t),t=e}return t},parseDot1:function(e){e=this.parseDot2(e);if(e){for(var i=e;i.nodeType===amiTwig.expr.tokens.DOT;i=i.nodeLeft);i.q&&(i.nodeType===amiTwig.expr.tokens.FUN?i.nodeValue in amiTwig.stdlib?i.nodeValue="amiTwig.stdlib."+i.nodeValue:i.nodeValue="_."+i.nodeValue:i.nodeType===amiTwig.expr.tokens.VAR&&(i.nodeValue="_."+i.nodeValue),i.q=!1)}return e},parseDot2:function(e){for(var i,t,r=this.parseDot3(e);this.tokenizer.checkType(amiTwig.expr.tokens.DOT);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),"."),this.tokenizer.next(),i=this.parseDot3(e),t.nodeLeft=r,t.nodeRight=i,r=t;return r},parseDot3:function(e){for(var i,t,r=this.parseX(e);this.tokenizer.checkType(amiTwig.expr.tokens.LB1);){if(this.tokenizer.next(),i=this.parseNullCoalescing(),!this.tokenizer.checkType(amiTwig.expr.tokens.RB1))throw"syntax error, line `"+this.line+"`, `]` expected";this.tokenizer.next(),(t=new amiTwig.expr.Node(amiTwig.expr.tokens.DOT,"[]")).nodeLeft=r,t.nodeRight=i,r=t}return r},parseX:function(e){var i;if(i=this.parseGroup())return i;if(i=this.parseArray())return i;if(i=this.parseObject())return i;if(i=this.parseFunVar(e))return i;if(i=this.parseTerminal())return i;throw"syntax error, line `"+this.line+"`, syntax error or tuncated expression"},parseGroup:function(){var e;if(this.tokenizer.checkType(amiTwig.expr.tokens.LP)){if(this.tokenizer.next(),e=this.parseNullCoalescing(),this.tokenizer.checkType(amiTwig.expr.tokens.RP))return this.tokenizer.next(),e;throw"syntax error, line `"+this.line+"`, `)` expected"}return null},parseArray:function(){var e,i;if(this.tokenizer.checkType(amiTwig.expr.tokens.LB1)){if(this.tokenizer.next(),i=this._parseSinglets(),this.tokenizer.checkType(amiTwig.expr.tokens.RB1))return this.tokenizer.next(),(e=new amiTwig.expr.Node(amiTwig.expr.tokens.LST,"Array")).list=i,e;throw"syntax error, line `"+this.line+"`, `]` expected"}return null},parseObject:function(){var e,i;if(this.tokenizer.checkType(amiTwig.expr.tokens.LB2)){if(this.tokenizer.next(),i=this._parseDoublets(),this.tokenizer.checkType(amiTwig.expr.tokens.RB2))return this.tokenizer.next(),(e=new amiTwig.expr.Node(amiTwig.expr.tokens.DIC,"Object")).dict=i,e;throw"syntax error, line `"+this.line+"`, `}` expected"}return null},parseFunVar:function(e){var i;if(this.tokenizer.checkType(amiTwig.expr.tokens.SID)){if((i=new amiTwig.expr.Node(0,e?"filter_"+this.tokenizer.peekToken():this.tokenizer.peekToken())).q=!0,this.tokenizer.next(),this.tokenizer.checkType(amiTwig.expr.tokens.LP)){if(this.tokenizer.next(),i.list=this._parseSinglets(),!this.tokenizer.checkType(amiTwig.expr.tokens.RP))throw"syntax error, line `"+this.line+"`, `)` expected";this.tokenizer.next(),i.nodeType=amiTwig.expr.tokens.FUN}else i.nodeType=e?amiTwig.expr.tokens.FUN:amiTwig.expr.tokens.VAR,i.list=[];return i}return null},_parseSinglets:function(){for(var e=[];!1===this.tokenizer.checkType(amiTwig.expr.tokens.RX)&&(this._parseSinglet(e),!0===this.tokenizer.checkType(amiTwig.expr.tokens.COMMA));)this.tokenizer.next();return e},_parseDoublets:function(){for(var e={};!1===this.tokenizer.checkType(amiTwig.expr.tokens.RB2)&&(this._parseDoublet(e),!0===this.tokenizer.checkType(amiTwig.expr.tokens.COMMA));)this.tokenizer.next();return e},_parseSinglet:function(e){e.push(this.parseNullCoalescing())},_parseDoublet:function(e){if(!this.tokenizer.checkType(amiTwig.expr.tokens.TERMINAL))throw"syntax error, line `"+this.line+"`, terminal expected";var i=this.tokenizer.peekToken();if(this.tokenizer.next(),!this.tokenizer.checkType(amiTwig.expr.tokens.COLON))throw"syntax error, line `"+this.line+"`, `:` expected";this.tokenizer.next(),e[i]=this.parseNullCoalescing()},parseTerminal:function(){var e,i,t;if(this.tokenizer.checkType(amiTwig.expr.tokens.TERMINAL)){if(e=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),!this.tokenizer.checkType(amiTwig.expr.tokens.RANGE))return e;if(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),this.tokenizer.checkType(amiTwig.expr.tokens.TERMINAL))return i=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t.nodeLeft=e,t.nodeRight=i,t}return null}},amiTwig.expr.Node=function(e,i){this.$init(e,i)},amiTwig.expr.Node.prototype={$init:function(e,i){this.nodeType=e,this.nodeValue=i,this.nodeLeft=null,this.nodeRight=null,this.list=null,this.dict=null},_dump:function(e,i,t){var r,n=t[0];if(e.push("\tnode"+n+' [label="'+this.nodeValue.replace(/"/g,'\\"')+'"];'),this.nodeLeft&&(r=++t[0],i.push("\tnode"+n+" -> node"+r+";"),this.nodeLeft._dump(e,i,t)),this.nodeRight&&(r=++t[0],i.push("\tnode"+n+" -> node"+r+";"),this.nodeRight._dump(e,i,t)),this.list)for(var s in this.list)r=++t[0],i.push("\tnode"+n+" -> node"+r+' [label="['+s.replace(/"/g,'\\"')+']"];'),this.list[s]._dump(e,i,t);if(this.dict)for(var o in this.dict)r=++t[0],i.push("\tnode"+n+" -> node"+r+' [label="['+o.replace(/"/g,'\\"')+']"];'),this.dict[o]._dump(e,i,t)},dump:function(){var e=[],i=[];return this._dump(e,i,[0]),"digraph ast {\n\trankdir=TB;\n"+e.join("\n")+"\n"+i.join("\n")+"\n}"}},amiTwig.tmpl={},amiTwig.tmpl.Compiler=function(e){this.$init(e)},amiTwig.tmpl.Compiler.prototype={STATEMENT_RE:/\{%\s*([a-zA-Z]+)\s*((?:.|\n)*?)\s*%\}/,COMMENT_RE:/\{#\s*((?:.|\n)*?)\s*#\}/g,_count:function(e){for(var i=0,t=e.length,r=0;r<t;r++)"\n"===e[r]&&i++;return i},$init:function(e){var i=1;this.rootNode={line:i,keyword:"@root",expression:"",blocks:[{expression:"@true",list:[]}],value:""};var t,r=[this.rootNode],n=[0];for(e=e.replace(this.COMMENT_RE,"");;e=e.substr(a)){var s=r[r.length-1],o=n[n.length-1],a=e.match(this.STATEMENT_RE);if(null===a){i+=this._count(e),s.blocks[o].list.push({line:i,keyword:"@text",expression:"",blocks:[],value:e});for(var h=[],p=r.length-1;0<p;p--)"if"===r[p].keyword?h.push("missing keyword `endif`"):"for"===r[p].keyword&&h.push("missing keyword `endfor`");if(0<h.length)throw"syntax error, line `"+i+"`, "+h.join(", ");break}var l=a[0],u=a[1],c=a[2],g=a.index+0,a=a.index+l.length,l=e.substr(0,g),g=e.substr(0,a);switch(i+=this._count(g),l&&s.blocks[o].list.push(t={line:i,keyword:"@text",expression:"",blocks:[],value:l}),u){case"flush":case"autoescape":case"spaceless":case"verbatim":break;case"do":case"set":case"include":s.blocks[o].list.push(t={line:i,keyword:u,expression:c,blocks:[],value:""});break;case"if":case"for":s.blocks[o].list.push(t={line:i,keyword:u,blocks:[{expression:c,list:[]}],value:""}),r.push(t),n.push(0);break;case"elseif":if("if"!==s.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `elseif`";o=s.blocks.length,s.blocks.push({expression:c,list:[]}),n[n.length-1]=o;break;case"else":if("if"!==s.keyword&&"for"!==s.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `else`";o=s.blocks.length,s.blocks.push({expression:"@true",list:[]}),n[n.length-1]=o;break;case"endif":if("if"!==s.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `endif`";r.pop(),n.pop();break;case"endfor":if("for"!==s.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `endfor`";r.pop(),n.pop();break;default:throw"syntax error, line `"+i+"`, unknown keyword `"+u+"`"}}},dump:function(){return JSON.stringify(this.rootNode,null,2)}},amiTwig.engine={VARIABLE_RE:/\{\{\s*(.*?)\s*\}\}/g,_render:function(t,r,n,s){var o,e,i,a,h=this;switch(void 0===n&&(n={}),void 0===s&&(s={}),this.dict=n,this.tmpls=s,r.keyword){case"do":amiTwig.expr.cache.eval(r.expression,r.line,n);break;case"set":if(!(a=r.expression.match(/((?:[a-zA-Z_$][a-zA-Z0-9_$]*\.)*[a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*(.+)/)))throw"syntax error, line `"+r.line+"`, invalid `set` statement";var p,l=a[1].split("."),u=l.length-1;if("window"===l[0]||"global"===l[0]){if("undefined"!=typeof window)p=window;else{if("undefined"==typeof global)throw"internal error";p=global}T=1}else p=n,T=0;for(var c=T;c<u;c++){if(!p[l[c]])throw"runtime error, line `"+r.line+"`, `"+a[1]+"` not declared";p=p[l[c]]}p[l[c]]=amiTwig.expr.cache.eval(a[2],r.line,n);break;case"@text":t.push(r.value.replace(this.VARIABLE_RE,function(e,i){i=amiTwig.expr.cache.eval(i,r.line,n);return null!=i?i:""}));break;case"if":case"@root":r.blocks.every(function(e){if("@true"===(o=e.expression)||amiTwig.expr.cache.eval(o,r.line,n)){for(var i in e.list)h._render(t,e.list[i],n,s);return!1}return!0});break;case"for":if(a=r.blocks[0].expression.match(/([a-zA-Z_$][a-zA-Z0-9_$]*)\s*,\s*([a-zA-Z_$][a-zA-Z0-9_$]*)\s+in\s+(.+)/))e=a[1],i=a[2],m=a[3];else{if(!(a=r.blocks[0].expression.match(/([a-zA-Z_$][a-zA-Z0-9_$]*)\s+in\s+(.+)/)))throw"syntax error, line `"+r.line+"`, invalid `for` statement";e=a[1],i=null,m=a[2]}var g,k=amiTwig.expr.cache.eval(m,r.line,n),T=Object.prototype.toString.call(k);if("[object Object]"===T)g=i?Object.entries(k):Object.keys(k);else{if(g=k,"[object Array]"!==T&&"[object String]"!==T)throw"syntax error, line `"+r.line+"`, right operande not iterable";if(i)throw"syntax error, line `"+r.line+"`, right operande not an object"}var f=g.length;if(0<f){var d=0,w=r.blocks[0].list;if(i){var m=n[e],k=n[i],T=n.loop;n.loop={length:f,parent:n.loop};for(var x=_createForOfIteratorHelperLoose(g);!(b=x()).done;){var _,y=b.value,b=y[0],y=y[1];for(_ in n[e]=b,n[i]=y,n.loop.first=0===d,n.loop.last=d===f-1,n.loop.revindex0=f-d,n.loop.index0=d,d++,n.loop.revindex=f-d,n.loop.index=d,w)this._render(t,w[_],n,s)}n.loop=T,n[i]=k,n[e]=m}else{var S=n[e],N=n.loop;n.loop={length:f,parent:n.loop};for(var v=_createForOfIteratorHelperLoose(g);!(z=v()).done;){var O,z=z.value;for(O in n[e]=z,n.loop.first=0===d,n.loop.last=d===f-1,n.loop.revindex0=f-d,n.loop.index0=d,d++,n.loop.revindex=f-d,n.loop.index=d,w)this._render(t,w[O],n,s)}n.loop=N,n[e]=S}}else if(1<r.blocks.length){var L,A=r.blocks[1].list;for(L in A)this._render(t,A[L],n,s)}break;case"include":N=r.expression,S=(a=N.match(/(.+)\s+with\s+(.+)\s+only$/))?(o=a[1],I=a[2],!1):(a=N.match(/(.+)\s+with\s+(.+)$/))?(o=a[1],I=a[2],!0):(a=N.match(/(.+)\s+only$/))?(o=a[1],!(I="{}")):(o=N,I="{}",!0),N=amiTwig.expr.cache.eval(o,r.line,n)||"";if("[object String]"!==Object.prototype.toString.call(N))throw"runtime error, line `"+r.line+"`, string expected";var I=amiTwig.expr.cache.eval(I,r.line,n)||{};if("[object Object]"!==Object.prototype.toString.call(I))throw"runtime error, line `"+r.line+"`, object expected";t.push(amiTwig.stdlib.include(N,I,S,!1))}},render:function(e,i,t){void 0===i&&(i={}),void 0===t&&(t={});var r=[];switch(Object.prototype.toString.call(e)){case"[object String]":this._render(r,new amiTwig.tmpl.Compiler(e).rootNode,i,t);break;case"[object Object]":this._render(r,e,i,t)}return r.join("")}},amiTwig.expr.cache={dict:{},eval:function _eval(expression,line,_){var f,f=expression in this.dict?this.dict[expression]:this.dict[expression]=eval(amiTwig.expr.interpreter.getJS(new amiTwig.expr.Compiler(expression,line)));return _=_||{},f.call(_,_)}},amiTwig.stdlib={isUndefined:function(e){return void 0===e},isDefined:function(e){return void 0!==e},isNull:function(e){return null===e},isNotNull:function(e){return null!==e},isEmpty:function(e){if(null===e||!1===e||""===e)return!0;var i=Object.prototype.toString.call(e);return"[object Array]"===i&&0===e.length||"[object Object]"===i&&0===Object.keys(e).length},isNumber:function(e){return"[object Number]"===Object.prototype.toString.call(e)},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},isObject:function(e){return"[object Object]"===Object.prototype.toString.call(e)},isIterable:function(e){e=Object.prototype.toString.call(e);return"[object String]"===e||"[object Array]"===e||"[object Object]"===e},isEven:function(e){return this.isNumber(e)&&0==(1&e)},isOdd:function(e){return this.isNumber(e)&&1==(1&e)},isInObject:function(e,i){return this.isArray(i)||this.isString(i)?0<=i.indexOf(e):!!this.isObject(i)&&e in i},isInRange:function(e,i,t){return this.isNumber(i)&&this.isNumber(t)?i<=e&&e<=t:!(!this.isString(i)||1!==i.length||!this.isString(t)||1!==t.length)&&(e.charCodeAt(0)>=i.charCodeAt(0)&&e.charCodeAt(0)<=t.charCodeAt(0))},range:function(e,i,t){void 0===t&&(t=1);var r=[];if(this.isNumber(e)&&this.isNumber(i))for(var n=e;n<=i;n+=t)r.push(n);else if(this.isString(e)&&1===e.length&&this.isString(i)&&1===i.length)for(var s=e.charCodeAt(0);s<=i.charCodeAt(0);s+=t)r.push(String.fromCharCode(s));return r},filter_length:function(e){return this.isString(e)||this.isArray(e)?e.length:this.isObject(e)?Object.keys(e).length:0},filter_first:function(e){return(this.isString(e)||this.isArray(e))&&0<e.length?e[0]:""},filter_last:function(e){return(this.isString(e)||this.isArray(e))&&0<e.length?e[e.length-1]:""},filter_slice:function(e,i,t){return this.isString(e)||this.isArray(e)?e.slice(i,t):null},filter_merge:function(){if(1<arguments.length){if(this.isString(arguments[0])){var e,i=[];for(e in arguments){if(!this.isString(arguments[e]))return null;i.push(arguments[e])}return i.join("")}if(this.isArray(arguments[0])){var t,r=[];for(t in arguments){var n,s=arguments[t];if(!this.isArray(s))return null;for(n in s)r.push(s[n])}return r}if(this.isObject(arguments[0])){var o,a={};for(o in arguments){var h,p=arguments[o];if(!this.isObject(p))return null;for(h in p)a[h]=p[h]}return a}}return null},filter_sort:function(e){return this.isArray(e)?e.sort():[]},filter_reverse:function(e){return this.isArray(e)?e.reverse():[]},filter_join:function(e,i){return this.isArray(e)?e.join(i):""},filter_keys:function(e){return this.isObject(e)?Object.keys(e):[]},filter_column:function(e,i){return this.isArray(e)?e.map(function(e){return e[i]}):[]},filter_batch:function(e,i,t){void 0===t&&(t="");var r=[];if(this.isArray(e)&&this.isNumber(i)){var n=e.length;if(0<n){for(var s,o=Math.ceil(n/i)*i,a=0;a<n;a+=i)r.push(s=e.slice(a,a+i));for(var h=n;h<o;h+=1)s.push(t)}}return r},startsWith:function(e,i){if(this.isString(e)&&this.isString(i))return 0===e.indexOf(i,0);return!1},endsWith:function(e,i){if(this.isString(e)&&this.isString(i)){var t=e.length-i.length;return e.indexOf(i,t)===t}return!1},match:function(e,i){if(this.isString(e)&&this.isString(i)){var t=i.indexOf("/"),r=i.lastIndexOf("/");if(0===t||t<r)try{return new RegExp(i.substring(t+1,r),i.substring(r+1)).test(e)}catch(e){}}return!1},filter_default:function(e,i){return e||i||""},filter_lower:function(e){return this.isString(e)?e.toLowerCase():""},filter_upper:function(e){return this.isString(e)?e.toUpperCase():""},filter_capitalize:function(e){return this.isString(e)?e.trim().toLowerCase().replace(/^\S/g,function(e){return e.toUpperCase()}):""},filter_title:function(e){return this.isString(e)?e.trim().toLowerCase().replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()}):""},filter_trim:function(e){return this.isString(e)?e.trim():""},_replace:function(e,i,t){var r=[],n=e.length,s=i.length;if(s!=t.length)throw"internal error";e:for(var o=0;o<n;o+=0){for(var a=e.substring(o),h=0;h<s;h+=1)if(0===a.indexOf(i[h])){r.push(t[h]),o+=i[h].length;continue e}r.push(e.charAt(o++))}return r.join("")},_textToHtmlX:["&",'"',"<",">"],_textToHtmlY:["&amp;","&quot;","&lt;","&gt;"],_textToStringX:["\\","\n",'"',"'"],_textToStringY:["\\\\","\\n",'\\"',"\\'"],_textToJsonStringX:["\\","\n",'"'],_textToJsonStringY:["\\\\","\\n",'\\"'],filter_escape:function(e,i){if(this.isString(e))switch(i||"html"){case"html":case"html_attr":return this._replace(e,this._textToHtmlX,this._textToHtmlY);case"js":case"string":return this._replace(e,this._textToStringX,this._textToStringY);case"json":return this._replace(e,this._textToJsonStringX,this._textToJsonStringY);case"url":return encodeURIComponent(e);default:return e}return""},filter_url_encode:function(e){return this.isString(e)?encodeURIComponent(e):""},filter_nl2br:function(e){return this.isString(e)?e.replace(/\n/g,"<br/>"):""},filter_raw:function(e){return this.isString(e)?e:""},filter_replace:function(e,i){return this.isString(e)&&this.isObject(i)?this._replace(e,Object.keys(i),Object.values(i)):""},filter_split:function(e,i,t){return this.isString(e)?e.split(i,t):[]},filter_abs:function(e){return Math.abs(e)},filter_round:function(e,i){switch(i){case"ceil":return Math.ceil(e);case"floor":return Math.floor(e);default:return Math.round(e)}},min:function(){var e,i=1===arguments.length&&(this.isArray(arguments[0])||this.isObject(arguments[0]))?arguments[0]:arguments,t=Number.POSITIVE_INFINITY;for(e in i){if(!this.isNumber(i[e]))return Number.NaN;t>i[e]&&(t=i[e])}return t},max:function(){var e,i=1===arguments.length&&(this.isArray(arguments[0])||this.isObject(arguments[0]))?arguments[0]:arguments,t=Number.NEGATIVE_INFINITY;for(e in i){if(!this.isNumber(i[e]))return Number.NaN;t<i[e]&&(t=i[e])}return t},random:function(e){var i=Math.random();if(e){if(this.isArray(e)||this.isObject(e)){var t=Object.keys(e);return e[t[Math.floor(t.length*i)]]}if(this.isString(e))return e[Math.floor(e.length*i)];if(this.isNumber(e))return Math.floor(e*i)}return e=Number.MAX_SAFE_INTEGER,Math.floor(e*i)},filter_json_encode:function(e,i){return JSON.stringify(e,null,this.isNumber(i)?i:2)},filter_json_jspath:function(e,i){return"undefined"!=typeof JSPath?JSPath.apply(i,e):[]},include:function(e,i,t,r){if(void 0===i&&(i={}),void 0===t&&(t=!0),void 0===r&&(r=!1),e in amiTwig.engine.tmpls){var n={};if(t)for(var s in amiTwig.engine.dict)n[s]=amiTwig.engine.dict[s];if(i)for(var o in i)n[o]=i[o];return amiTwig.engine.render(amiTwig.engine.tmpls[e],n)}if(!r)throw"runtime error, could not open `"+e+"`";return""}},amiTwig.stdlib.filter_e=amiTwig.stdlib.filter_escape,amiTwig.expr.interpreter={_getJS:function(e){var i,t,r,n;switch(e.nodeType){case amiTwig.expr.tokens.LST:for(var s in i=[],e.list)i.push(this._getJS(e.list[s]));return"["+i.join(",")+"]";case amiTwig.expr.tokens.DIC:for(var o in i=[],e.dict)i.push(o+":"+this._getJS(e.dict[o]));return"{"+i.join(",")+"}";case amiTwig.expr.tokens.FUN:for(var a in i=[],e.list)i.push(this._getJS(e.list[a]));return e.nodeValue+"("+i.join(",")+")";case amiTwig.expr.tokens.VAR:for(var h in i=[],e.list)i.push("["+this._getJS(e.list[h])+"]");return 0<i.length?e.nodeValue+i.join(""):e.nodeValue;case amiTwig.expr.tokens.TERMINAL:return e.nodeValue;case amiTwig.expr.tokens.IS:switch(t=this._getJS(e.nodeLeft),e.nodeRight.nodeType){case amiTwig.expr.tokens.DEFINED:return"amiTwig.stdlib.isDefined("+t+")";case amiTwig.expr.tokens.NULL:return"amiTwig.stdlib.isNull("+t+")";case amiTwig.expr.tokens.EMPTY:return"amiTwig.stdlib.isEmpty("+t+")";case amiTwig.expr.tokens.ITERABLE:return"amiTwig.stdlib.isIterable("+t+")";case amiTwig.expr.tokens.EVEN:return"amiTwig.stdlib.isEven("+t+")";case amiTwig.expr.tokens.ODD:return"amiTwig.stdlib.isOdd("+t+")";default:throw"internal error"}case amiTwig.expr.tokens.IN:return e.nodeRight.nodeType!==amiTwig.expr.tokens.RANGE?"amiTwig.stdlib.isInObject("+(t=this._getJS(e.nodeLeft))+","+(r=this._getJS(e.nodeRight))+")":"amiTwig.stdlib.isInRange("+this._getJS(e.nodeLeft)+","+(t=e.nodeRight.nodeLeft.nodeValue)+","+(r=e.nodeRight.nodeRight.nodeValue)+")";case amiTwig.expr.tokens.STARTS_WITH:return"amiTwig.stdlib.startsWith("+(t=this._getJS(e.nodeLeft))+","+(r=this._getJS(e.nodeRight))+")";case amiTwig.expr.tokens.ENDS_WITH:return"amiTwig.stdlib.endsWith("+(t=this._getJS(e.nodeLeft))+","+(r=this._getJS(e.nodeRight))+")";case amiTwig.expr.tokens.MATCHES:return"amiTwig.stdlib.match("+(t=this._getJS(e.nodeLeft))+","+(r=this._getJS(e.nodeRight))+")";case amiTwig.expr.tokens.RANGE:return"amiTwig.stdlib.range("+(t=this._getJS(e.nodeLeft))+","+(r=this._getJS(e.nodeRight))+")";case amiTwig.expr.tokens.DOT:return t=this._getJS(e.nodeLeft),r=this._getJS(e.nodeRight),"."===e.nodeValue[0]?t+"."+r:t+"["+r+"]";case amiTwig.expr.tokens.FLDIV:return"Math.floor("+(t=this._getJS(e.nodeLeft))+"/"+(r=this._getJS(e.nodeRight))+")";case amiTwig.expr.tokens.POWER:return"Math.pow("+(t=this._getJS(e.nodeLeft))+","+(r=this._getJS(e.nodeRight))+")";case amiTwig.expr.tokens.DOUBLE_QUESTION:return"(("+(t=this._getJS(e.nodeLeft))+") || ("+(r=this._getJS(e.nodeRight))+"))";default:if(null===e.nodeLeft&&null!==e.nodeRight)return(n=e.nodeType!==amiTwig.expr.tokens.NOT?e.nodeValue:"!")+"("+this._getJS(e.nodeRight)+")";if(null!==e.nodeLeft&&null===e.nodeRight)return n=e.nodeType!==amiTwig.expr.tokens.NOT?e.nodeValue:"!","("+this._getJS(e.nodeLeft)+")"+n;if(null!==e.nodeLeft&&null!==e.nodeRight){switch(e.nodeType){case amiTwig.expr.tokens.LOGICAL_OR:n="||";break;case amiTwig.expr.tokens.LOGICAL_AND:n="&&";break;case amiTwig.expr.tokens.BITWISE_OR:n="|";break;case amiTwig.expr.tokens.BITWISE_XOR:n="^";break;case amiTwig.expr.tokens.BITWISE_AND:n="&";break;case amiTwig.expr.tokens.CONCAT:n="+";break;default:n=e.nodeValue}return"("+(t=this._getJS(e.nodeLeft))+n+(r=this._getJS(e.nodeRight))+")"}}},getJS:function(e){return"(function(_) { return "+this._getJS(e.rootNode)+"; })"},eval:function _eval(expr,_){return _=_||{},eval(this.getJS(expr)).call(_,_)}}}();